# 系統分析網站 - 技術棧與架構規格

## 📋 專案概述

本文件定義「系統分析網站」的技術棧選擇、架構決策、開發規範和非功能需求，作為後端開發的技術指導方針。

## 🚀 後端技術棧

### 1.1 程式語言
**選擇：Node.js (v18 LTS)**
- **理由**：
  - 與前端 JavaScript/TypeScript 技術棧一致，降低開發維護成本
  - 豐富的 npm 生態系統，特別是 Mermaid 解析相關套件
  - 非同步 I/O 特性適合處理大量 Mermaid 解析任務
  - 開發效率高，適合快速迭代的 MVP 階段

### 1.2 框架
**選擇：Express.js + TypeScript**
- **理由**：
  - 輕量級、靈活，適合 API 導向的後端服務
  - TypeScript 提供強型別支援，提升程式碼品質
  - 豐富的中間件生態系統
  - 學習曲線平緩，團隊上手容易

### 1.3 ORM/資料庫存取
**選擇：Prisma ORM**
- **理由**：
  - 強型別支援，與 TypeScript 完美整合
  - 自動生成型別定義，減少手動維護
  - 優秀的遷移管理功能
  - 支援 PostgreSQL 的進階功能（JSONB、UUID 等）

## 🎨 前端技術棧

### 2.1 框架
**選擇：React 18 + TypeScript**
- **理由**：
  - 成熟的生態系統和社群支援
  - 組件化架構適合複雜的系統分析介面
  - TypeScript 提供型別安全
  - 與後端技術棧保持一致

### 2.2 UI 元件庫
**選擇：Ant Design (antd)**
- **理由**：
  - 企業級 UI 元件，適合管理系統
  - 豐富的表格、樹狀結構、表單元件
  - 良好的 TypeScript 支援
  - 可客製化主題

### 2.3 狀態管理
**選擇：Zustand**
- **理由**：
  - 輕量級，學習成本低
  - TypeScript 支援良好
  - 適合中小型應用狀態管理
  - 與 React 18 相容性好

### 2.4 Mermaid 渲染
**選擇：Mermaid.js v10.x**
- **理由**：
  - 最新版本支援更多圖表類型
  - 效能優化，支援大型圖表
  - 與後端解析邏輯保持一致

## 🗄️ 資料庫選擇

### 3.1 PostgreSQL 版本
**選擇：PostgreSQL 15+**
- **理由**：
  - 支援 JSONB 型別，提升 DTO Schema 查詢效能
  - 優秀的 UUID 支援
  - 觸發器和函數支援完善
  - 企業級穩定性和效能

### 3.2 資料庫部署
**選擇：雲端 RDS + 本地開發環境**
- **生產環境**：AWS RDS PostgreSQL 或 GCP Cloud SQL
- **開發環境**：Docker Compose 本地 PostgreSQL
- **理由**：雲端服務提供自動備份、監控、擴展能力

### 3.3 多資料庫支援
**暫不支援**：專案初期專注於 PostgreSQL，後續可考慮 MySQL 支援

## 🔧 開發環境

### 4.1 部署架構
**選擇：單體應用 + 微服務準備**
- **初期**：單體架構，便於開發和部署
- **後續**：可拆分為專案管理、API 管理、AI 服務等微服務

### 4.2 容器化
**選擇：Docker + Docker Compose**
- **開發環境**：Docker Compose 管理多服務
- **生產環境**：Docker 容器部署
- **理由**：簡化環境配置，確保開發與生產環境一致

### 4.3 雲端平台
**選擇：AWS**
- **理由**：成熟的雲端服務，成本效益好
- **服務選擇**：EC2、RDS PostgreSQL、ElastiCache Redis、S3

### 4.4 CI/CD 工具
**選擇：GitHub Actions**
- **理由**：與 GitHub 整合良好，免費額度充足
- **流程**：自動測試 → 建置 → 部署

## 🚀 快取與佇列

### 5.1 Redis 配置
**選擇：Redis 7.x**
- **用途**：
  - 分散式鎖（流水號分配）
  - Mermaid 解析結果快取
  - 會話快取
- **部署**：AWS ElastiCache Redis

### 5.2 訊息佇列
**選擇：暫時不需要**
- **理由**：初期需求可透過非同步處理滿足
- **後續**：可考慮 RabbitMQ 或 AWS SQS

### 5.3 快取策略
**選擇：多層快取**
- **本地快取**：Node.js 記憶體快取（小量資料）
- **分散式快取**：Redis（共享資料、鎖機制）

## 📐 架構決策

### 6.1 API 設計
**選擇：REST API + OpenAPI 規範**
- **認證**：JWT Token
- **文檔**：Swagger/OpenAPI 3.0
- **版本控制**：URL 路徑版本（/v1/）
- **理由**：標準化、易於理解、工具支援完善

### 6.2 API 版本管理策略
**版本控制策略**：
- **URL 路徑版本**：/v1/、/v2/ 等
- **向下相容性**：新版本必須保持舊版本 API 的相容性
- **版本棄用策略**：
  - 提前 6 個月通知版本棄用
  - 提供遷移指南和工具
  - 支援多版本並行運行
- **版本標頭**：支援 Accept-Version 標頭作為備選方案
- **版本生命週期**：
  - 穩定版本：支援 24 個月
  - 維護版本：只修復安全問題
  - 棄用版本：提供 6 個月過渡期

### 6.3 即時通訊
**選擇：暫時不需要 WebSocket**
- **理由**：初期需求可透過輪詢或 Server-Sent Events 滿足
- **後續**：可考慮 Socket.io 或 WebSocket

### 6.4 資料庫設計原則
- **正規化**：適度正規化，避免過度複雜
- **索引策略**：查詢導向的索引設計
- **分區策略**：按 project_id 分區（後續擴展）

## 🤖 AI 整合

### 7.1 AI 服務選擇
**選擇：OpenAI GPT-4 + Claude 3.5 Sonnet**
- **理由**：
  - GPT-4：擅長程式碼生成和結構化輸出
  - Claude：擅長技術文檔和邏輯分析
  - 雙模型策略提升品質和可靠性

### 7.2 API 限流策略
- **用戶級限流**：每小時 100 次 AI 請求
- **專案級限流**：每個專案每天 1000 次
- **成本控制**：Token 使用量監控和告警

### 7.3 成本控制機制
- **模型選擇**：根據任務複雜度選擇合適模型
- **快取策略**：相似請求結果快取
- **批量處理**：多個請求合併處理

## 💼 業務規則

### 8.1 租戶架構
**選擇：單租戶架構**
- **理由**：初期需求簡單，降低複雜度
- **後續**：可升級為多租戶架構

### 8.2 資源限制
- **專案數量**：每用戶最多 50 個專案
- **Module 數量**：每專案最多 100 個
- **API 數量**：每專案最多 500 個
- **DTO 數量**：每專案最多 1000 個

### 8.3 權限模型
**基本權限控制**：
- **專案擁有者**：完全控制權限
- **編輯者**：可編輯內容，不可刪除專案
- **唯讀者**：只能查看，不可修改
- **API 存取**：基於 JWT Token 的認證

## 🛠️ 開發規範

### 9.1 命名規範
- **後端**：camelCase（變數、函數）、PascalCase（類別）
- **資料庫**：snake_case（表名、欄位名）
- **API 路徑**：kebab-case（/api/v1/use-cases）
- **錯誤碼**：BIZ_ 前綴（BIZ_VALIDATION_ERROR）

### 9.2 錯誤處理中間件
**統一錯誤處理策略**：
- **錯誤分類**：
  - `BIZ_`：業務邏輯錯誤（BIZ_VALIDATION_ERROR、BIZ_NOT_FOUND）
  - `SYS_`：系統錯誤（SYS_DATABASE_ERROR、SYS_EXTERNAL_API_ERROR）
  - `AUTH_`：認證授權錯誤（AUTH_TOKEN_EXPIRED、AUTH_INSUFFICIENT_PERMISSION）
- **錯誤處理中間件**：
  - 統一捕獲所有未處理的錯誤
  - 自動記錄錯誤日誌
  - 生產環境隱藏敏感錯誤資訊
  - 支援多語言錯誤訊息
- **錯誤回應格式**：
  ```json
  {
    "success": false,
    "error": {
      "code": "BIZ_VALIDATION_ERROR",
      "message": "驗證失敗",
      "details": {
        "field": "email",
        "reason": "格式不正確"
      },
      "request_id": "req-uuid-123",
      "timestamp": "2024-01-01T00:00:00Z"
    }
  }
  ```
- **錯誤追蹤**：每個錯誤都包含唯一的 request_id，便於追蹤和除錯

### 9.3 程式碼標準
- **TypeScript**：strict 模式，ESLint + Prettier
- **後端**：遵循 Express.js 最佳實踐
- **前端**：遵循 React 最佳實踐
- **測試覆蓋率**：後端 80%+，前端 70%+

### 9.4 測試策略
- **後端測試**：Jest + Supertest
- **前端測試**：Jest + React Testing Library
- **E2E 測試**：Playwright
- **API 測試**：Postman 集合

## 📊 非功能需求

### 10.1 效能指標
- **API 回應時間**：95% 請求 < 200ms
- **頁面載入時間**：首頁 < 2s，其他頁面 < 1s
- **併發用戶數**：支援 1000 同時在線用戶
- **資料處理能力**：單專案支援 10,000+ API 定義

### 10.2 可用性要求
- **SLA 目標**：99.5% 可用性
- **備份頻率**：每日自動備份，保留 30 天
- **故障恢復時間**：RTO < 4 小時，RPO < 1 小時

### 10.3 擴展性
- **水平擴展**：支援多實例部署
- **資料庫擴展**：支援讀寫分離
- **快取擴展**：Redis 叢集支援

## 🔌 整合需求

### 11.1 版本控制整合
**選擇：GitHub 整合**
- **功能**：專案與 Git 儲存庫關聯
- **用途**：追蹤需求變更、版本管理
- **後續**：可考慮 GitLab、Bitbucket 支援

### 11.2 匯出功能
- **OpenAPI 3.0**：API 定義匯出
- **Postman 集合**：測試集合匯出
- **Markdown**：需求文檔匯出
- **PDF**：正式規格書匯出

### 11.3 用戶認證與授權系統
**選擇：JWT Token + Refresh Token 機制**
- **認證方式**：用戶名/密碼 + JWT Token
- **Token 管理**：Access Token (短期) + Refresh Token (長期)
- **安全性**：密碼雜湊、登入失敗限制、Token 黑名單
- **後續**：可整合 LDAP、SAML、OAuth2、SSO

#### 11.3.1 JWT Token 設計
**Token 結構**：
- **Access Token**：短期有效（15 分鐘），用於 API 存取
- **Refresh Token**：長期有效（7 天），用於重新取得 Access Token
- **Token 內容**：用戶 ID、角色、專案權限、發行時間、過期時間

**Token 安全策略**：
- Access Token 過期後自動使用 Refresh Token 更新
- Refresh Token 過期後要求重新登入
- 支援 Token 撤銷（登出時加入黑名單）
- Token 輪換：每次 Refresh 都產生新的 Token 對

#### 11.3.2 認證流程設計
**登入流程**：
1. 用戶提交用戶名/密碼
2. 驗證憑證，檢查帳號狀態
3. 產生 Access Token + Refresh Token
4. 回傳 Token 對和用戶基本資訊
5. 記錄登入日誌

**Token 更新流程**：
1. 前端檢測 Access Token 過期
2. 使用 Refresh Token 請求新的 Token 對
3. 後端驗證 Refresh Token 有效性
4. 產生新的 Token 對並回傳
5. 舊的 Refresh Token 加入黑名單

**登出流程**：
1. 前端發送登出請求
2. 將當前 Token 對加入黑名單
3. 清除前端 Token 儲存
4. 記錄登出日誌

#### 11.3.3 安全性考量
**密碼安全**：
- 使用 bcrypt 雜湊演算法（cost factor: 12）
- 密碼複雜度要求：最少 8 位，包含大小寫字母、數字
- 登入失敗限制：5 次失敗後鎖定帳號 30 分鐘
- 密碼過期提醒：90 天後提醒更換

**Token 安全**：
- Token 簽名使用強密鑰（最少 256 位）
- Token 過期時間適中，平衡安全性和用戶體驗
- 支援多裝置登入，但限制同時登入數量
- Token 黑名單使用 Redis 儲存，支援自動過期

**登入安全**：
- 記錄登入 IP、裝置、地點等資訊
- 異常登入檢測（異地登入、異常時間等）
- 登入失敗記錄和告警
- 支援強制登出功能（管理員可強制用戶登出）

## 📈 監控與日誌

### 12.1 健康檢查系統
**詳細健康檢查端點**：
- **基本健康檢查**：`GET /health`
  ```json
  {
    "status": "healthy",
    "timestamp": "2024-01-01T00:00:00Z",
    "version": "1.0.0"
  }
  ```
- **就緒狀態檢查**：`GET /health/ready`
  ```json
  {
    "status": "ready",
    "checks": {
      "database": {
        "status": "ok",
        "response_time": "15ms",
        "last_check": "2024-01-01T00:00:00Z"
      },
      "redis": {
        "status": "ok",
        "response_time": "5ms",
        "last_check": "2024-01-01T00:00:00Z"
      },
      "ai_service": {
        "status": "ok",
        "response_time": "200ms",
        "last_check": "2024-01-01T00:00:00Z"
      },
      "mermaid_parser": {
        "status": "ok",
        "response_time": "10ms",
        "last_check": "2024-01-01T00:00:00Z"
      }
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```
- **存活狀態檢查**：`GET /health/live`
  ```json
  {
    "status": "alive",
    "uptime": "86400",
    "memory_usage": "45%",
    "cpu_usage": "12%",
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```
- **詳細狀態檢查**：`GET /health/detailed`
  - 包含所有子系統的詳細狀態
  - 資料庫連線池狀態
  - Redis 記憶體使用情況
  - 外部 API 服務狀態
  - 系統資源使用情況

### 12.2 APM 工具
**選擇：New Relic 或 DataDog**
- **功能**：應用效能監控、錯誤追蹤
- **整合**：Node.js 代理程式自動檢測

### 12.3 日誌管理
**選擇：ELK Stack 或雲端日誌服務**
- **結構化日誌**：JSON 格式，便於分析
- **日誌等級**：ERROR、WARN、INFO、DEBUG
- **日誌保留**：生產環境 90 天，開發環境 30 天

### 12.4 告警通知
**選擇：Slack + Email**
- **告警條件**：
  - API 錯誤率 > 5%
  - 回應時間 > 500ms
  - 資料庫連線失敗
  - AI 服務異常

## 🚀 部署架構圖

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (React)   │    │   後端 (Node.js) │    │   資料庫層      │
│                 │    │                 │    │                 │
│ - Ant Design    │◄──►│ - Express.js    │◄──►│ - PostgreSQL    │
│ - Zustand       │    │ - TypeScript    │    │ - Redis         │
│ - Mermaid.js    │    │ - Prisma ORM    │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   雲端服務      │
                       │                 │
                       │ - AWS           │
                       │ - Docker        │
                       │ - CI/CD         │
                       └─────────────────┘
```

## 📋 技術債務與風險

### 13.1 技術風險
- **AI 服務依賴**：外部 API 穩定性風險
- **Mermaid 解析**：複雜圖表效能風險
- **資料一致性**：大量資料的檢查效能

### 13.2 緩解策略
- **AI 服務**：多模型備援、本地快取
- **Mermaid 解析**：非同步處理、結果快取
- **資料一致性**：增量檢查、背景任務

## 🎯 開發里程碑

### 14.1 Phase 1 (MVP)
- 基本 CRUD 功能
- 簡單的 Mermaid 解析
- 基本一致性檢查

### 14.2 Phase 2 (增強)
- AI 草稿生成
- 進階一致性檢查
- 效能優化

### 14.3 Phase 3 (企業級)
- 多租戶支援
- 進階權限控制
- 企業整合功能

## 📚 參考資源

- [Express.js 官方文檔](https://expressjs.com/)
- [Prisma 官方文檔](https://www.prisma.io/)
- [PostgreSQL 官方文檔](https://www.postgresql.org/)
- [Mermaid.js 官方文檔](https://mermaid.js.org/)
- [Ant Design 官方文檔](https://ant.design/)

---

**版本**：v1.0  
**更新日期**：2024-01-01  
**負責人**：後端開發團隊  
**審核人**：技術架構師
