ã€Œç³»çµ±åˆ†æç¶²ç«™ã€æ ¸å¿ƒæ¥­å‹™é‚è¼¯è¦æ ¼ï¼ˆAI ç”¢ç¢¼ç”¨ï¼‰- å„ªåŒ–ç‰ˆ

ç›®æ¨™ï¼šæœ¬è¦æ ¼æ¶µè“‹æ ¸å¿ƒæ¥­å‹™é‚è¼¯ã€è³‡æ–™çµæ§‹ã€èªè­‰èˆ‡æ¬Šé™æ§åˆ¶ç³»çµ±ã€‚ä¾› AI ç›´æ¥ç”¢ç”Ÿå¾Œç«¯ç¨‹å¼ç¢¼ï¼ˆCRUDã€é—œè¯ã€è§£æèˆ‡ä¸€è‡´æ€§æª¢æŸ¥ã€èªè­‰ä¸­ä»‹è»Ÿé«”ã€æ¬Šé™æ§åˆ¶ï¼‰èˆ‡åŸºæœ¬å‰ç«¯ä¸²æ¥ã€‚

âš ï¸ é‡è¦è®Šæ›´èªªæ˜ï¼š
- çµ±ä¸€ä½¿ç”¨ UUID ä½œç‚ºæ‰€æœ‰ ID æ¬„ä½ï¼Œé¿å…ä»£ç¢¼æ··ç”¨å•é¡Œ
- æ–°å¢å®Œæ•´çš„åˆªé™¤ç­–ç•¥èˆ‡ç´„æŸå®šç¾©
- å¼·åŒ–ä½µç™¼è™•ç†èˆ‡äº¤æ˜“æ©Ÿåˆ¶
- æ”¹å–„ API è¨­è¨ˆèˆ‡éŒ¯èª¤è™•ç†
- å„ªåŒ–è³‡æ–™åº«ç´¢å¼•èˆ‡ç´„æŸ
- æ–°å¢æ‰¹é‡æ“ä½œèˆ‡åˆ†é æ”¯æ´
- **æ–°å¢å®Œæ•´çš„èªè­‰èˆ‡æ¬Šé™æ§åˆ¶ç³»çµ±**
- **å¼·åŒ–è³‡æ–™å®‰å…¨èˆ‡å­˜å–æ§åˆ¶**

0) åè©èˆ‡ç¯„ç–‡

Moduleï¼ˆåŠŸèƒ½æ¨¡çµ„ï¼‰ï¼šä»¥æ¥­å‹™èƒ½åŠ›åˆ†çµ„çš„å®¹å™¨ï¼ˆä¾‹ï¼šç™»å…¥èˆ‡å®‰å…¨ï¼‰ã€‚

Use Caseï¼ˆä½¿ç”¨è€…æ¡ˆä¾‹ï¼‰ï¼šä½¿ç”¨è€…èˆ‡ç³»çµ±äº’å‹•çš„ä¸€å€‹ç›®æ¨™ï¼ˆä¾‹ï¼šç™»å…¥ï¼‰ã€‚

Sequence Diagramï¼ˆå¾ªåºåœ–ï¼‰ï¼šä»¥ Mermaid æ’°å¯«çš„æµç¨‹åœ–ï¼Œå°æ‡‰ Use Caseã€‚

API Contractï¼ˆAPI åˆç´„ï¼‰ï¼šæ–¹æ³• + è·¯å¾‘ + æ¨™é¡Œ + èªªæ˜ã€‚

DTO Schemaï¼ˆè³‡æ–™å‚³è¼¸ç‰©ä»¶ï¼‰ï¼šRequest/Response çš„çµæ§‹æè¿°ï¼ˆä»¥ JSON Schema å„²å­˜ï¼‰ã€‚

Linkï¼ˆé—œè¯ï¼‰ï¼šAPI â†” Sequenceï¼ˆæ­¥é©Ÿï¼‰ã€API â†” DTOï¼ˆreq/res è§’è‰²ï¼‰ã€‚

ç›®æ¨™ä½¿ç”¨æµç¨‹ï¼šModule â†’ Use Case â†’ Sequence Diagram â†’ API/DTOï¼ˆéˆçµå¯è¿½æº¯ï¼‰ã€‚

1) è­˜åˆ¥ç¢¼èˆ‡ä»£ç¢¼è¦ç¯„

1.1 ä»£ç¢¼æ ¼å¼ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰

MOD-{NNN}ï¼šModule ä»£ç¢¼ï¼ˆä¾‹ï¼šMOD-001ï¼‰ï¼Œä¸‰ä½æ•¸èµ·ï¼Œæº¢å‡ºç¹¼çºŒå¢é•·ï¼ˆå¦‚ MOD-1001ï¼‰

UC-{NNN}ï¼šUse Case ä»£ç¢¼ï¼ˆä¾‹ï¼šUC-001ï¼‰ï¼Œä»¥ Module ç‚º Scope

SD-{NNN}ï¼šSequence ä»£ç¢¼ï¼ˆä¾‹ï¼šSD-001ï¼‰ï¼Œä»¥ Use Case ç‚º Scope

API-{DOMAIN}-{NNN}ï¼šAPI ä»£ç¢¼ï¼ˆä¾‹ï¼šAPI-AUTH-001ï¼‰ï¼ŒDOMAIN ç‚ºæ¥­å‹™é ˜åŸŸï¼ˆå¦‚ AUTHã€ORDERï¼‰ï¼Œè‹¥ç„¡å‰‡ç”¨ GEN

DTO-{Name}-{NNN}ï¼šDTO ä»£ç¢¼ï¼ˆä¾‹ï¼šDTO-LoginRequest-001ï¼‰ï¼ŒName å–è‡ª title çš„è‹±æ•¸é§å³°åŸºåº•

ä»£ç¢¼åœ¨å°ˆæ¡ˆå…§å”¯ä¸€ã€‚NNN é è¨­ 3 ä½å·¦è£œé›¶ï¼ˆ001ã€002â€¦ï¼‰ï¼Œè¶…é 999 ä»ç¹¼çºŒï¼š1000ã€1001â€¦

1.2 æµæ°´è™Ÿ Scope è¦å‰‡

é¡å‹ï½œScope Keyï½œèªªæ˜
---|---|---
Moduleï½œproject_id + type=MODULEï½œå°ˆæ¡ˆåº•ä¸‹é€è™Ÿ
Use Caseï½œproject_id + type=USE_CASE + module_idï½œæ¯å€‹æ¨¡çµ„è‡ªå·±çš„æµæ°´
Sequenceï½œproject_id + type=SEQUENCE + use_case_idï½œæ¯å€‹ç”¨ä¾‹è‡ªå·±çš„æµæ°´
APIï½œproject_id + type=API + domainï½œæ¯å€‹ domain è‡ªå·±çš„æµæ°´
DTOï½œproject_id + type=DTO + dto_name_baseï½œåŒååŸºåº•å…±ç”¨æµæ°´

1.3 æµæ°´è™Ÿç”Ÿæˆæ©Ÿåˆ¶

- æ¡ç”¨è¨ˆæ•¸å™¨è¡¨ï¼ˆseq_counterï¼‰ç®¡ç†å„ Scope çš„æµæ°´è™Ÿ
- ä½¿ç”¨è¡Œç´šé–ä¿è­‰ä½µç™¼å®‰å…¨
- ç·¨è™Ÿåªå¢ä¸æ¸›ï¼Œåˆªé™¤è³‡æºä¸å›æ”¶ç·¨è™Ÿ
- äº¤æ˜“å…§åŸå­æ€§åˆ†é…ï¼Œç¢ºä¿å”¯ä¸€æ€§
- æ–°å¢é‡è©¦æ©Ÿåˆ¶ï¼šé–å®šå¤±æ•—æ™‚è‡ªå‹•é‡è©¦æœ€å¤š 3 æ¬¡ï¼Œé–“éš” 100ms
- æ‰¹é‡å»ºç«‹æ™‚ä½¿ç”¨å–®ä¸€äº¤æ˜“ï¼Œé¿å…å¤šæ¬¡é–è¡¨

1.4 ä»£ç¢¼ç”ŸæˆéŒ¯èª¤è™•ç†

- DTO title èƒå–å¤±æ•—æ™‚ï¼Œä½¿ç”¨ fallback å‘½åï¼šDTO-Unknown-{NNN}
- domain åƒæ•¸ä¸åˆæ³•æ™‚ï¼Œè‡ªå‹•è½‰æ›ç‚º "GEN"
- æ‰€æœ‰ä»£ç¢¼ç”ŸæˆéŒ¯èª¤è¨˜éŒ„åˆ°ç³»çµ±æ—¥èªŒï¼Œä¸ä¸­æ–·æ“ä½œ

2) è³‡æ–™æ¨¡å‹ï¼ˆæœ€å°å¿…è¦æ¬„ä½ï¼‰

2.1 Userï¼ˆç”¨æˆ¶èªè­‰ï¼‰

id (uuid) // çµ±ä¸€ä½¿ç”¨ UUID æ ¼å¼
email (string) // å”¯ä¸€ï¼Œç”¨æ–¼ç™»å…¥
password (string) // bcrypt é›œæ¹Šå¾Œçš„å¯†ç¢¼
name (string?) // é¡¯ç¤ºåç¨±
role (string) // è§’è‰²ï¼šuser, admin, super_admin
isActive (boolean) // å¸³è™Ÿæ˜¯å¦å•Ÿç”¨
isLocked (boolean) // å¸³è™Ÿæ˜¯å¦è¢«é–å®š
lockReason (string?) // é–å®šåŸå› 
failedLoginAttempts (int) // ç™»å…¥å¤±æ•—æ¬¡æ•¸
lastLoginAt (timestamp?) // æœ€å¾Œç™»å…¥æ™‚é–“
lastPasswordChange (timestamp?) // æœ€å¾Œå¯†ç¢¼è®Šæ›´æ™‚é–“
emailVerified (boolean) // Email æ˜¯å¦å·²é©—è­‰
emailVerificationToken (string?) // Email é©—è­‰ Token
passwordResetToken (string?) // å¯†ç¢¼é‡è¨­ Token
passwordResetExpires (timestamp?) // å¯†ç¢¼é‡è¨­ Token éæœŸæ™‚é–“
createdAt (timestamp)
updatedAt (timestamp)

2.2 RefreshTokenï¼ˆåˆ·æ–° Token ç®¡ç†ï¼‰

id (uuid)
userId (uuid) // å¤–éµï¼Œä½¿ç”¨ UUID
token (string) // Refresh Token å€¼
deviceInfo (string?) // è£ç½®è³‡è¨Š
ipAddress (string?) // IP ä½å€
expiresAt (timestamp) // éæœŸæ™‚é–“
isRevoked (boolean) // æ˜¯å¦å·²æ’¤éŠ·
revokedAt (timestamp?) // æ’¤éŠ·æ™‚é–“
createdAt (timestamp)

2.3 Project

id (uuid) // çµ±ä¸€ä½¿ç”¨ UUID æ ¼å¼
name (string)
description (string?)
owner_id (uuid) // å°ˆæ¡ˆæ“æœ‰è€…ï¼Œå¤–éµåˆ° User
status (string) // å°ˆæ¡ˆç‹€æ…‹ï¼šPLANNING | IN_PROGRESS | REVIEW | COMPLETED
created_at (timestamp)
updated_at (timestamp)

2.4 ProjectMemberï¼ˆå°ˆæ¡ˆæˆå“¡æ¬Šé™ï¼‰

id (uuid)
project_id (uuid) // å¤–éµåˆ° Project
user_id (uuid) // å¤–éµåˆ° User
role (string) // è§’è‰²ï¼šOWNER | EDITOR | VIEWER
permissions (jsonb) // è©³ç´°æ¬Šé™è¨­å®š
invited_by (uuid?) // é‚€è«‹äººï¼Œå¤–éµåˆ° User
invited_at (timestamp) // é‚€è«‹æ™‚é–“
accepted_at (timestamp?) // æ¥å—é‚€è«‹æ™‚é–“
created_at (timestamp)
updated_at (timestamp)

2.2 Module

id (uuid)

project_id (uuid) // å¤–éµï¼Œä½¿ç”¨ UUID

mod_code (string) // MOD-xxx

title (string)

parent_id (uuid?) // å…è¨±æ¨¹ç‹€ï¼Œä½¿ç”¨ UUID

order (int?) // è‡ªå‹•ç¶­è­·ï¼Œæ’å…¥æ™‚è‡ªå‹•åˆ†é…

created_at (timestamp)

updated_at (timestamp)

2.3 UseCase

id (uuid)

project_id (uuid)

module_id (uuid)

uc_code (string) // UC-xxx

title (string)

summary (string?)

created_at (timestamp)

updated_at (timestamp)

2.4 SequenceDiagram

id (uuid)

project_id (uuid)

use_case_id (uuid)

sd_code (string) // SD-xxx

title (string)

mermaid_src (text) // åŸå§‹ç¢¼

created_at (timestamp)

updated_at (timestamp)

2.5 ApiContract

id (uuid)

project_id (uuid)

api_code (string) // API-...

method (enum: GET|POST|PUT|DELETE|PATCH)

path (string) // ä¾‹ï¼š/auth/login

title (string)

desc (string?)

created_at (timestamp)

updated_at (timestamp)

2.6 DtoSchema

id (uuid)

project_id (uuid)

dto_code (string) // DTO-...

title (string)

schema_json (jsonb) // JSON Schema ç‰©ä»¶ï¼Œä½¿ç”¨ JSONB æå‡æ•ˆèƒ½

kind (enum: request|response)

created_at (timestamp)

updated_at (timestamp)

2.7 Linkï¼šApiSequenceLink

id (uuid)

api_id (uuid) // å¤–éµï¼Œä½¿ç”¨ UUID

sequence_id (uuid) // å¤–éµï¼Œä½¿ç”¨ UUID

step_ref (string) // åœ–ä¸­æ­¥é©Ÿçš„åƒç…§æ¨™è­˜ï¼ˆè‡ªè¨‚æ–‡å­—ï¼‰

line_number (int?) // æ–°å¢ï¼šMermaid åŸå§‹ç¢¼ä¸­çš„è¡Œè™Ÿï¼Œä¾¿æ–¼å®šä½

created_at (timestamp)

2.8 Linkï¼šApiDtoLink

id (uuid)

api_id (uuid) // å¤–éµï¼Œä½¿ç”¨ UUID

dto_id (uuid) // å¤–éµï¼Œä½¿ç”¨ UUID

role (enum: req|res)

created_at (timestamp)

3) Mermaid è§£æè¦ç¯„ï¼ˆä¾›ä¸€è‡´æ€§æª¢æŸ¥ä½¿ç”¨ï¼‰

3.1 è§£ææ™‚æ©Ÿèˆ‡ç­–ç•¥

- åŒæ­¥è§£æï¼šå»ºç«‹/æ›´æ–° Sequence Diagram æ™‚ç«‹å³è§£æ
- ç•°æ­¥è§£æï¼šå¤§é‡è³‡æ–™æ™‚ä½¿ç”¨èƒŒæ™¯ä»»å‹™ï¼Œé¿å…é˜»å¡
- å¿«å–æ©Ÿåˆ¶ï¼šè§£æçµæœå¿«å– 5 åˆ†é˜ï¼Œæå‡é‡è¤‡æŸ¥è©¢æ•ˆèƒ½

3.2 API æ¨™è¨˜æ ¼å¼

æ¨™æº–ï¼š[API:API-AUTH-001] æ–‡å­—èªªæ˜â€¦

å¯¬é¬†ï¼šåŒ…å« API-AUTH-001 å³è¦–ç‚º API åƒç…§

3.3 DTO æ¨™è¨˜æ ¼å¼

Login(LoginRequest) -> LoginResponse

æˆ–åœ¨æ–‡å­—ä¸­å‡ºç¾ DTO-LoginRequest-001 / DTO-LoginResponse-001

3.4 è§£æè¦å‰‡ï¼ˆå»ºè­° regexï¼‰

APIï¼š/\[API:([A-Z0-9-]+)\]/gï¼Œè‹¥æœªå‘½ä¸­å‰‡é€€åŒ–ï¼š/\bAPI-[A-Z0-9-]+\b/g

DTOï¼š/\bDTO-[A-Za-z0-9-]+\b/g æˆ–ä»¥æ‹¬è™Ÿèªæ³•æŠ½å–åç¨±å¾Œæ˜ å°„ä»£ç¢¼

3.5 ä¸€è‡´æ€§æª¢æŸ¥çš„æœ€ä½è¦æ±‚

å¾ªåºåœ–èƒ½æŠ½å‡ºè‡³å°‘ä¸€å€‹ API ä»£ç¢¼ã€‚DTO å¯ç”± API é—œè¯è£œè¶³ã€‚

4) æ ¸å¿ƒæ¥­å‹™æµç¨‹

4.1 å»ºç«‹åˆ†æéª¨æ¶

å»ºç«‹ Project â†’ Module

Module ä¸‹å»ºç«‹ Use Case

Use Case ä¸‹å»ºç«‹ SequenceDiagramï¼ˆå¡« mermaid_srcï¼‰

å¾å¾ªåºåœ–è§£ææˆ–äººå·¥æŒ‡å®šç”¢ç”Ÿ ApiContract

ç‚º API ç¶å®š DTOï¼ˆè‡³å°‘ 1 å€‹ req + 1 å€‹ resï¼‰

4.2 è¿½æº¯ï¼ˆTraceabilityï¼‰

ä»»æ„è³‡æºå¯å‘ä¸ŠæŸ¥ï¼šAPI â†’ Sequence â†’ Use Case â†’ Module

ä»»æ„ Use Case å¯å±•é–‹ï¼šSequences, APIs, DTOs

4.3 ä¸€è‡´æ€§æª¢æŸ¥ï¼ˆConsistencyï¼‰

ä»¥å°ˆæ¡ˆç‚ºå–®ä½æª¢æŸ¥ï¼š

å¾ªåºåœ–æ¨™è¨˜çš„ API æ˜¯å¦å­˜åœ¨ ApiContractï¼Ÿ

æ¯å€‹ API æ˜¯å¦è‡³å°‘ç¶å®š 1 req + 1 res DTOï¼Ÿ

å­¤å…’ï¼šæœªè¢«ä»»ä½• Sequence åƒç…§çš„ APIï¼›æœªè¢«ä»»ä½• API åƒç…§çš„ DTO

å›å‚³ç¼ºå¤±èˆ‡å­¤å…’æ¸…å–®ï¼ŒåŒ…å«è©³ç´°ä½ç½®è³‡è¨Šã€‚

5) èªè­‰èˆ‡æ¬Šé™æ§åˆ¶ç³»çµ±

5.1 èªè­‰ä¸­ä»‹è»Ÿé«”ï¼ˆAuthentication Middlewareï¼‰

5.1.1 JWT Token é©—è­‰
- æ‰€æœ‰å—ä¿è­·çš„ API å¿…é ˆåœ¨ Header ä¸­æ”œå¸¶ `Authorization: Bearer <token>`
- Token éæœŸæ™‚è‡ªå‹•å›å‚³ 401 éŒ¯èª¤
- ç„¡æ•ˆ Token æ™‚å›å‚³ 401 éŒ¯èª¤
- æ”¯æ´ Token è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶

5.1.2 èªè­‰ä¸­ä»‹è»Ÿé«”å¯¦ä½œ
```typescript
// auth.middleware.ts
export const authenticateToken = async (req: Request, res: Response, next: NextFunction) => {
  const authHeader = req.headers.authorization;
  const token = authHeader && authHeader.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({
      success: false,
      error: { code: 'AUTH_TOKEN_MISSING', message: 'ç¼ºå°‘èªè­‰ Token' }
    });
  }
  
  try {
    const payload = await authService.verifyAccessToken(token);
    req.user = payload; // å°‡ä½¿ç”¨è€…è³‡è¨Šé™„åŠ åˆ°è«‹æ±‚ç‰©ä»¶
    next();
  } catch (error) {
    return res.status(401).json({
      success: false,
      error: { code: 'AUTH_TOKEN_INVALID', message: 'Token ç„¡æ•ˆæˆ–å·²éæœŸ' }
    });
  }
};
```

5.2 æ¬Šé™æ§åˆ¶ä¸­ä»‹è»Ÿé«”ï¼ˆAuthorization Middlewareï¼‰

5.2.1 å°ˆæ¡ˆæ¬Šé™æª¢æŸ¥
- æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™å­˜å–ç‰¹å®šå°ˆæ¡ˆ
- æ”¯æ´ä¸‰ç¨®è§’è‰²ï¼šOWNERï¼ˆæ“æœ‰è€…ï¼‰ã€EDITORï¼ˆç·¨è¼¯è€…ï¼‰ã€VIEWERï¼ˆå”¯è®€è€…ï¼‰
- åŸºæ–¼å°ˆæ¡ˆæˆå“¡è¡¨é€²è¡Œæ¬Šé™é©—è­‰

5.2.2 æ¬Šé™æª¢æŸ¥ä¸­ä»‹è»Ÿé«”å¯¦ä½œ
```typescript
// permission.middleware.ts
export const checkProjectPermission = (requiredRole: 'OWNER' | 'EDITOR' | 'VIEWER') => {
  return async (req: Request, res: Response, next: NextFunction) => {
    const { projectId } = req.params;
    const userId = req.user.userId;
    
    try {
      const member = await projectService.getProjectMember(projectId, userId);
      
      if (!member) {
        return res.status(403).json({
          success: false,
          error: { code: 'PERMISSION_DENIED', message: 'ç„¡æ¬Šé™å­˜å–æ­¤å°ˆæ¡ˆ' }
        });
      }
      
      // æª¢æŸ¥è§’è‰²æ¬Šé™
      const roleHierarchy = { 'OWNER': 3, 'EDITOR': 2, 'VIEWER': 1 };
      if (roleHierarchy[member.role] < roleHierarchy[requiredRole]) {
        return res.status(403).json({
          success: false,
          error: { code: 'INSUFFICIENT_PERMISSION', message: 'æ¬Šé™ä¸è¶³' }
        });
      }
      
      req.projectMember = member; // å°‡å°ˆæ¡ˆæˆå“¡è³‡è¨Šé™„åŠ åˆ°è«‹æ±‚ç‰©ä»¶
      next();
    } catch (error) {
      next(error);
    }
  };
};
```

5.3 æ¬Šé™æ¨¡å‹è¨­è¨ˆ

5.3.1 è§’è‰²æ¬Šé™å®šç¾©
- **OWNERï¼ˆæ“æœ‰è€…ï¼‰**ï¼š
  - å®Œå…¨æ§åˆ¶æ¬Šé™
  - å¯åˆªé™¤å°ˆæ¡ˆ
  - å¯é‚€è«‹/ç§»é™¤æˆå“¡
  - å¯ä¿®æ”¹å°ˆæ¡ˆè¨­å®š
- **EDITORï¼ˆç·¨è¼¯è€…ï¼‰**ï¼š
  - å¯ç·¨è¼¯å°ˆæ¡ˆå…§å®¹
  - å¯å»ºç«‹/ä¿®æ”¹/åˆªé™¤æ¨¡çµ„ã€ç”¨ä¾‹ã€API ç­‰
  - ä¸å¯åˆªé™¤å°ˆæ¡ˆ
  - ä¸å¯é‚€è«‹/ç§»é™¤æˆå“¡
- **VIEWERï¼ˆå”¯è®€è€…ï¼‰**ï¼š
  - åªèƒ½æŸ¥çœ‹å°ˆæ¡ˆå…§å®¹
  - ä¸å¯é€²è¡Œä»»ä½•ä¿®æ”¹æ“ä½œ

5.3.2 æ¬Šé™æª¢æŸ¥æ™‚æ©Ÿ
- **è®€å–æ“ä½œ**ï¼šéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™
- **å»ºç«‹æ“ä½œ**ï¼šéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™
- **ä¿®æ”¹æ“ä½œ**ï¼šéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™
- **åˆªé™¤æ“ä½œ**ï¼šéœ€è¦ OWNER æ¬Šé™
- **æˆå“¡ç®¡ç†**ï¼šéœ€è¦ OWNER æ¬Šé™

6) REST APIï¼ˆå„ªåŒ–ç‰ˆï¼‰

æ‰€æœ‰ç«¯é»é è¨­åŒä¸€ baseï¼Œä¾‹å¦‚ /v1ã€‚å›æ‡‰ä»¥ application/jsonã€‚

**é‡è¦è®Šæ›´**ï¼šæ‰€æœ‰æ¥­å‹™ API éƒ½éœ€è¦èªè­‰ï¼Œä¸¦æ ¹æ“šæ¬Šé™é€²è¡Œå­˜å–æ§åˆ¶ã€‚

5.1 èªè­‰ API

5.1.1 ç”¨æˆ¶ç™»å…¥
POST /auth/login
è«‹æ±‚ï¼š
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

å›æ‡‰ï¼š
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid-123",
      "email": "user@example.com",
      "name": "ä½¿ç”¨è€…åç¨±",
      "role": "user"
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "expiresIn": 900,
      "refreshExpiresIn": 604800
    }
  }
}
```

5.1.2 é‡æ–°æ•´ç† Token
POST /auth/refresh
è«‹æ±‚ï¼š
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

å›æ‡‰ï¼š
```json
{
  "success": true,
  "data": {
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "expiresIn": 900,
      "refreshExpiresIn": 604800
    }
  }
}
```

5.1.3 ç”¨æˆ¶ç™»å‡º
POST /auth/logout
è«‹æ±‚ï¼š
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

å›æ‡‰ï¼š
```json
{
  "success": true,
  "data": {
    "message": "ç™»å‡ºæˆåŠŸ"
  }
}
```

5.1.4 å–å¾—å€‹äººè³‡æ–™
GET /auth/profile
å›æ‡‰ï¼š
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid-123",
      "email": "user@example.com",
      "name": "ä½¿ç”¨è€…åç¨±",
      "role": "user",
      "isActive": true,
      "lastLoginAt": "2024-01-01T00:00:00Z",
      "createdAt": "2024-01-01T00:00:00Z"
    }
  }
}
```

5.1.5 æ›´æ–°å€‹äººè³‡æ–™
PATCH /auth/profile
è«‹æ±‚ï¼š
```json
{
  "name": "æ–°ä½¿ç”¨è€…åç¨±"
}
```

å›æ‡‰ï¼š
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid-123",
      "email": "user@example.com",
      "name": "æ–°ä½¿ç”¨è€…åç¨±",
      "role": "user",
      "updatedAt": "2024-01-01T00:00:00Z"
    }
  }
}
```

5.1.6 ä¿®æ”¹å¯†ç¢¼
PATCH /auth/password
è«‹æ±‚ï¼š
```json
{
  "currentPassword": "oldpassword123",
  "newPassword": "newpassword123"
}
```

å›æ‡‰ï¼š
```json
{
  "success": true,
  "data": {
    "message": "å¯†ç¢¼ä¿®æ”¹æˆåŠŸ"
  }
}
```

5.2 å°ˆæ¡ˆç®¡ç† API

5.1 çµ±ä¸€å›æ‡‰æ ¼å¼

æˆåŠŸå›æ‡‰ï¼š
```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2024-01-01T00:00:00Z"
}
```

éŒ¯èª¤å›æ‡‰ï¼š
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "è©³ç´°éŒ¯èª¤è¨Šæ¯",
    "details": { ... }
  },
  "timestamp": "2024-01-01T00:00:00Z"
}
```

5.2 åˆ†é æ”¯æ´

æ‰€æœ‰åˆ—è¡¨ API æ”¯æ´åˆ†é ï¼š
```json
{
  "success": true,
  "data": { ... },
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 100,
    "total_pages": 5
  }
}
```

5.3 Project

POST /projects â†’ å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼‰
GET /projects â†’ è®€å–å°ˆæ¡ˆåˆ—è¡¨ï¼ˆéœ€è¦èªè­‰ï¼Œåªé¡¯ç¤ºæœ‰æ¬Šé™çš„å°ˆæ¡ˆï¼‰
GET /projects/:id â†’ è®€å–å°ˆæ¡ˆè©³æƒ…ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
PATCH /projects/:id â†’ æ›´æ–°ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
DELETE /projects/:id â†’ åˆªé™¤ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ OWNER æ¬Šé™ï¼‰

5.3.1 å°ˆæ¡ˆæˆå“¡ç®¡ç†
POST /projects/:id/members â†’ é‚€è«‹æˆå“¡ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ OWNER æ¬Šé™ï¼‰
GET /projects/:id/members â†’ å–å¾—æˆå“¡åˆ—è¡¨ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
PATCH /projects/:id/members/:memberId â†’ ä¿®æ”¹æˆå“¡æ¬Šé™ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ OWNER æ¬Šé™ï¼‰
DELETE /projects/:id/members/:memberId â†’ ç§»é™¤æˆå“¡ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ OWNER æ¬Šé™ï¼‰

5.4 Module

POST /modules â†’ å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
GET /modules?project_id=...&page=1&size=20&parent_id=... â†’ è®€å–ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
PATCH /modules/:id â†’ æ›´æ–°ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
DELETE /modules/:id â†’ åˆªé™¤ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

POST /modules/batch â†’ æ‰¹é‡å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

è«‹æ±‚ä¾‹ï¼ˆmod_code ç”±å¾Œç«¯è‡ªå‹•ç”Ÿæˆï¼Œorder è‡ªå‹•åˆ†é…ï¼‰
```json
POST /modules
{
  "project_id": "uuid-123",
  "title": "ç™»å…¥èˆ‡å®‰å…¨",
  "parent_id": null
}
```

å›æ‡‰
```json
{
  "success": true,
  "data": {
    "id": "uuid-123",
    "project_id": "uuid-123",
    "mod_code": "MOD-001",
    "title": "ç™»å…¥èˆ‡å®‰å…¨",
    "parent_id": null,
    "order": 10,
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

5.5 Use Case

POST /use-cases â†’ å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
GET /use-cases?project_id=...&module_id=...&page=1&size=20 â†’ è®€å–ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
PATCH /use-cases/:id â†’ æ›´æ–°ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
DELETE /use-cases/:id â†’ åˆªé™¤ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

POST /use-cases/batch â†’ æ‰¹é‡å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

5.6 Sequence Diagram

POST /sequences â†’ å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
GET /sequences?project_id=...&use_case_id=...&page=1&size=20 â†’ è®€å–ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
PATCH /sequences/:id â†’ æ›´æ–°ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
DELETE /sequences/:id â†’ åˆªé™¤ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

POST /sequences/batch â†’ æ‰¹é‡å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

5.7 API Contract

POST /apis â†’ å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
GET /apis?project_id=...&domain=...&method=...&page=1&size=20 â†’ è®€å–ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
PATCH /apis/:id â†’ æ›´æ–°ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
DELETE /apis/:id â†’ åˆªé™¤ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

POST /apis/batch â†’ æ‰¹é‡å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

5.8 DTO Schema

POST /dtos â†’ å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
GET /dtos?project_id=...&kind=...&page=1&size=20 â†’ è®€å–ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
PATCH /dtos/:id â†’ æ›´æ–°ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
DELETE /dtos/:id â†’ åˆªé™¤ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

POST /dtos/batch â†’ æ‰¹é‡å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

5.9 Linkï¼šAPI â†” Sequenceï¼ˆæ­¥é©Ÿé—œè¯ï¼‰

POST /api-sequence-links â†’ å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
GET /api-sequence-links?sequence_id=...&api_id=...&page=1&size=20 â†’ è®€å–ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
DELETE /api-sequence-links/:id â†’ åˆªé™¤ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

POST /api-sequence-links/batch â†’ æ‰¹é‡å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

5.10 Linkï¼šAPI â†” DTOï¼ˆè§’è‰²ç¶å®šï¼‰

POST /api-dto-links â†’ å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰
GET /api-dto-links?api_id=...&role=...&page=1&size=20 â†’ è®€å–ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰
DELETE /api-dto-links/:id â†’ åˆªé™¤ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

POST /api-dto-links/batch â†’ æ‰¹é‡å»ºç«‹ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

5.11 çµ±ä¸€æ¸…å–®ï¼ˆä¾›å·¦å´æ¨¹ä¸€æ¬¡è¼‰å…¥ï¼Œæ”¯æ´åˆ†é ï¼‰

GET /catalog?project_id=...&page=1&size=100ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰

å›æ‡‰
```json
{
  "success": true,
  "data": {
    "modules": [
      { "id":"uuid-1","mod_code":"MOD-001","title":"ç™»å…¥èˆ‡å®‰å…¨","parent_id":null,"order":10 }
    ],
    "use_cases": [
      { "id":"uuid-2","module_id":"uuid-1","uc_code":"UC-001","title":"ç™»å…¥","summary":"..." }
    ],
    "sequences": [
      { "id":"uuid-3","use_case_id":"uuid-2","sd_code":"SD-001","title":"ç™»å…¥æµç¨‹" }
    ],
    "apis": [
      { "id":"uuid-4","api_code":"API-AUTH-001","method":"POST","path":"/auth/login","title":"ç™»å…¥ API" }
    ],
    "dtos": [
      { "id":"uuid-5","dto_code":"DTO-LoginRequest-001","title":"LoginRequest","kind":"request" }
    ]
  },
  "pagination": {
    "page": 1,
    "size": 100,
    "total": 5,
    "total_pages": 1
  }
}
```

5.12 è¿½æº¯ï¼ˆå¾ä»»ä¸€è³‡æºå‡ºç™¼ï¼‰

GET /trace/chain?api_id=...&sequence_id=...&use_case_id=...&module_id=...ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰

åƒæ•¸å¯æ›ï¼Œå›å‚³ç›¸é„°é—œè¯éˆã€‚

å›æ‡‰ï¼ˆä»¥ api_id ç‚ºä¾‹ï¼‰
```json
{
  "success": true,
  "data": {
    "api": { "id":"uuid-1","api_code":"API-AUTH-001","title":"ç™»å…¥ API" },
    "sequences": [{ "id":"uuid-2","sd_code":"SD-001","title":"ç™»å…¥æµç¨‹" }],
    "use_case": { "id":"uuid-3","uc_code":"UC-001","title":"ç™»å…¥" },
    "module": { "id":"uuid-4","mod_code":"MOD-001","title":"ç™»å…¥èˆ‡å®‰å…¨" }
  }
}
```

5.13 ä¸€è‡´æ€§æª¢æŸ¥ï¼ˆæ ¸å¿ƒï¼Œå¢å¼·ç‰ˆï¼‰

POST /consistency/check?project_id=...ï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ VIEWER ä»¥ä¸Šæ¬Šé™ï¼‰

ä¼ºæœå™¨ç«¯æœƒï¼š

æƒæè©²å°ˆæ¡ˆæ‰€æœ‰ SequenceDiagram.mermaid_src

è§£æ API ä»£ç¢¼ â†’ æª¢æŸ¥ ApiContract å­˜åœ¨

æª¢æŸ¥ API æ˜¯å¦å…·å‚™ req èˆ‡è‡³å°‘ä¸€å€‹ res DTO

æ‰¾å‡ºå­¤å…’ API/DTO

å›æ‡‰
```json
{
  "success": true,
  "data": {
    "missing_refs": {
      "apis": [
        { 
          "api_code": "API-ORDER-999",
          "referenced_in": [
            { "sequence_id": "uuid-1", "sequence_title": "è¨‚å–®æµç¨‹", "line_number": 15 }
          ]
        }
      ],
      "dtos": [
        { 
          "api_code": "API-AUTH-001",
          "missing": "req",
          "api_title": "ç™»å…¥ API"
        }
      ]
    },
    "orphans": {
      "apis": [
        { 
          "api_code": "API-PAY-003",
          "api_title": "æ”¯ä»˜ API",
          "created_at": "2024-01-01T00:00:00Z"
        }
      ],
      "dtos": [
        { 
          "dto_code": "DTO-Legacy-OldResponse-001",
          "dto_title": "Legacy Response",
          "created_at": "2024-01-01T00:00:00Z"
        }
      ]
    },
    "stats": {
      "sequences_scanned": 12,
      "apis_referenced": 28,
      "apis_defined": 30,
      "dtos_defined": 56,
      "links_checked": 84
    }
  }
}
```

5.14 AI è‰ç¨¿ç”¢ç”Ÿèˆ‡æ¡ç”¨ï¼ˆå„ªåŒ–ç‰ˆï¼‰

POST /ai/generateï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

è«‹æ±‚
```json
{
  "project_id": "uuid-123",
  "context": { "module_id": "uuid-456", "use_case_id": null },
  "prompt": "æ–°å¢å¿˜è¨˜å¯†ç¢¼æµç¨‹ï¼ŒEmail é©—è­‰ï¼Œå¯„é€é‡è¨­é€£çµ"
}
```

å›æ‡‰
```json
{
  "success": true,
  "data": {
    "draft_id": "draft-uuid-789",
    "draft": {
      "use_case": { "uc_code": "UC-003", "title": "å¿˜è¨˜å¯†ç¢¼", "summary": "..." },
      "sequence": { "sd_code": "SD-003", "title": "å¿˜è¨˜å¯†ç¢¼æµç¨‹", "mermaid_src": "sequenceDiagram\n..." },
      "apis": [
        { "api_code": "API-AUTH-003", "method": "POST", "path": "/auth/forgot-password", "title": "ç”³è«‹é‡è¨­" }
      ],
      "dtos": [
        { "dto_code": "DTO-ForgotPasswordRequest-001", "title": "ForgotPasswordRequest", "kind": "request", "schema_json": { "type": "object", "properties": {"email": {"type": "string"}}, "required": ["email"] } },
        { "dto_code": "DTO-ForgotPasswordResponse-001", "title": "ForgotPasswordResponse", "kind": "response", "schema_json": {"type": "object", "properties": {"ok": {"type": "boolean"}}, "required": ["ok"]} }
      ]
    }
  }
}
```

æ¡ç”¨è‰ç¨¿ï¼ˆåŸå­æ€§æ“ä½œï¼‰ï¼š
POST /ai/adopt-draftï¼ˆéœ€è¦èªè­‰ï¼Œéœ€è¦ EDITOR ä»¥ä¸Šæ¬Šé™ï¼‰

è«‹æ±‚
```json
{
  "draft_id": "draft-uuid-789",
  "project_id": "uuid-123"
}
```

å›æ‡‰
```json
{
  "success": true,
  "data": {
    "adopted_resources": {
      "use_case": { "id": "uuid-1", "uc_code": "UC-003" },
      "sequence": { "id": "uuid-2", "sd_code": "SD-003" },
      "apis": [{ "id": "uuid-3", "api_code": "API-AUTH-003" }],
      "dtos": [
        { "id": "uuid-4", "dto_code": "DTO-ForgotPasswordRequest-001" },
        { "id": "uuid-5", "dto_code": "DTO-ForgotPasswordResponse-001" }
      ],
      "links": [
        { "id": "uuid-6", "type": "api_dto", "api_id": "uuid-3", "dto_id": "uuid-4", "role": "req" },
        { "id": "uuid-7", "type": "api_dto", "api_id": "uuid-3", "dto_id": "uuid-5", "role": "res" }
      ]
    }
  }
}
```

6) ä¸€è‡´æ€§æª¢æŸ¥ï¼šå„ªåŒ–æ¼”ç®—æ³•ï¼ˆå½ç¢¼ï¼‰

```python
function checkConsistency(project_id):
  sequences = db.findSequences(project_id)
  referenced_api_codes = {}  # api_code -> [sequence_info]
  missing_refs = {"apis": [], "dtos": []}
  orphans = {"apis": [], "dtos": []}
  
  # æƒææ‰€æœ‰å¾ªåºåœ–
  for seq in sequences:
    codes = parseApiCodes(seq.mermaid_src)
    for code in codes:
      if code not in referenced_api_codes:
        referenced_api_codes[code] = []
      referenced_api_codes[code].append({
        "sequence_id": seq.id,
        "sequence_title": seq.title,
        "line_number": findLineNumber(seq.mermaid_src, code)
      })
      
      # æª¢æŸ¥ API æ˜¯å¦å­˜åœ¨
      api = db.findApiByCode(project_id, code)
      if not api:
        missing_refs.apis.append({
          "api_code": code,
          "referenced_in": referenced_api_codes[code]
        })
      else:
        # æª¢æŸ¥ DTO ç¶å®š
        links = db.findApiDtoLinks(api.id)
        hasReq = any(l.role == 'req' for l in links)
        hasRes = any(l.role == 'res' for l in links)
        
        if not hasReq:
          missing_refs.dtos.append({
            "api_code": api.api_code,
            "missing": "req",
            "api_title": api.title
          })
        if not hasRes:
          missing_refs.dtos.append({
            "api_code": api.api_code,
            "missing": "res",
            "api_title": api.title
          })

  # æ‰¾å‡ºå­¤å…’ API
  allApis = db.findApis(project_id)
  for api in allApis:
    if api.api_code not in referenced_api_codes:
      orphans.apis.append({
        "api_code": api.api_code,
        "api_title": api.title,
        "created_at": api.created_at
      })

  # æ‰¾å‡ºå­¤å…’ DTO
  allDtos = db.findDtos(project_id)
  for dto in allDtos:
    if not db.existsApiDtoLink(dto.id):
      orphans.dtos.append({
        "dto_code": dto.dto_code,
        "dto_title": dto.title,
        "created_at": dto.created_at
      })

  return {
    "missing_refs": missing_refs,
    "orphans": orphans,
    "stats": {
      "sequences_scanned": len(sequences),
      "apis_referenced": len(referenced_api_codes),
      "apis_defined": len(allApis),
      "dtos_defined": len(allDtos),
      "links_checked": sum(len(db.findApiDtoLinks(api.id)) for api in allApis)
    }
  }
```

7) å„ªåŒ–è³‡æ–™åº« DDLï¼ˆPostgreSQL ç¯„ä¾‹ï¼‰

7.1 ç”¨æˆ¶èªè­‰ç›¸é—œè¡¨

7.1.1 User è¡¨
```sql
CREATE TABLE "user" (
  id                        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email                     TEXT NOT NULL UNIQUE,
  password                  TEXT NOT NULL,
  name                      TEXT,
  role                      TEXT NOT NULL DEFAULT 'user' CHECK (role IN ('user', 'admin', 'super_admin')),
  is_active                 BOOLEAN NOT NULL DEFAULT true,
  is_locked                 BOOLEAN NOT NULL DEFAULT false,
  lock_reason               TEXT,
  failed_login_attempts     INTEGER NOT NULL DEFAULT 0,
  last_login_at             TIMESTAMP,
  last_password_change      TIMESTAMP,
  email_verified            BOOLEAN NOT NULL DEFAULT false,
  email_verification_token  TEXT,
  password_reset_token      TEXT,
  password_reset_expires    TIMESTAMP,
  created_at                TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at                TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX ix_user_email ON "user"(email);
CREATE INDEX ix_user_role ON "user"(role);
CREATE INDEX ix_user_active ON "user"(is_active);
CREATE INDEX ix_user_locked ON "user"(is_locked);
```

7.1.2 RefreshToken è¡¨
```sql
CREATE TABLE refresh_token (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  token         TEXT NOT NULL UNIQUE,
  device_info   TEXT,
  ip_address    TEXT,
  expires_at    TIMESTAMP NOT NULL,
  is_revoked    BOOLEAN NOT NULL DEFAULT false,
  revoked_at    TIMESTAMP,
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX ix_refresh_token_user ON refresh_token(user_id);
CREATE INDEX ix_refresh_token_token ON refresh_token(token);
CREATE INDEX ix_refresh_token_expires ON refresh_token(expires_at);
CREATE INDEX ix_refresh_token_revoked ON refresh_token(is_revoked);
```

7.1.3 ç”¨æˆ¶ç›¸é—œè§¸ç™¼å™¨
```sql
-- è‡ªå‹•æ›´æ–° updated_at
CREATE TRIGGER trigger_update_user_updated_at
  BEFORE UPDATE ON "user"
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- å¯†ç¢¼è®Šæ›´æ™‚è‡ªå‹•æ›´æ–° last_password_change
CREATE OR REPLACE FUNCTION update_password_change_time()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.password != OLD.password THEN
    NEW.last_password_change = CURRENT_TIMESTAMP;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_password_change_time
  BEFORE UPDATE ON "user"
  FOR EACH ROW
  EXECUTE FUNCTION update_password_change_time();

-- ç™»å…¥æˆåŠŸæ™‚é‡ç½®å¤±æ•—æ¬¡æ•¸
CREATE OR REPLACE FUNCTION reset_failed_login_attempts()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.last_login_at IS NOT NULL AND OLD.last_login_at IS NULL THEN
    NEW.failed_login_attempts = 0;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_reset_failed_login_attempts
  BEFORE UPDATE ON "user"
  FOR EACH ROW
  EXECUTE FUNCTION reset_failed_login_attempts();
```

7.2 æµæ°´è™Ÿè¨ˆæ•¸å™¨è¡¨
```sql
CREATE TABLE seq_counter (
  id            BIGSERIAL PRIMARY KEY,
  project_id    UUID NOT NULL,
  scope_type    TEXT NOT NULL CHECK (scope_type IN ('MODULE', 'USE_CASE', 'SEQUENCE', 'API', 'DTO')),
  scope_ref1    TEXT,           -- e.g. module_id / use_case_id / domain / dto_name_base
  scope_ref2    TEXT,           -- ä¿ç•™æ¬„ä½
  next_number   BIGINT NOT NULL DEFAULT 1,
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (project_id, scope_type, scope_ref1, scope_ref2)
);

CREATE INDEX ix_seq_counter_project ON seq_counter(project_id);
CREATE INDEX ix_seq_counter_scope ON seq_counter(scope_type, scope_ref1);
```

7.2 Project
```sql
CREATE TABLE project (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  owner_id UUID REFERENCES "user"(id) ON DELETE SET NULL,
  status TEXT NOT NULL DEFAULT 'PLANNING' CHECK (status IN ('PLANNING', 'IN_PROGRESS', 'REVIEW', 'COMPLETED')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX ix_project_name ON project(name);
CREATE INDEX ix_project_owner ON project(owner_id);
CREATE INDEX ix_project_status ON project(status);
```

7.3 ProjectMemberï¼ˆå°ˆæ¡ˆæˆå“¡æ¬Šé™ï¼‰
```sql
CREATE TABLE project_member (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('OWNER', 'EDITOR', 'VIEWER')),
  permissions JSONB DEFAULT '{}',
  invited_by UUID REFERENCES "user"(id) ON DELETE SET NULL,
  invited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  accepted_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX ux_project_member_unique ON project_member(project_id, user_id);
CREATE INDEX ix_project_member_project ON project_member(project_id);
CREATE INDEX ix_project_member_user ON project_member(user_id);
CREATE INDEX ix_project_member_role ON project_member(project_id, role);
```

7.3 Module
```sql
CREATE TABLE module (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  mod_code TEXT NOT NULL,
  title TEXT NOT NULL,
  parent_id UUID REFERENCES module(id) ON DELETE CASCADE,
  "order" INT NOT NULL DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX ux_module_code ON module(project_id, mod_code);
CREATE INDEX ix_module_project ON module(project_id);
CREATE INDEX ix_module_parent ON module(parent_id);
CREATE INDEX ix_module_order ON module(project_id, "order");

-- è‡ªå‹•ç¶­è­· order çš„è§¸ç™¼å™¨
CREATE OR REPLACE FUNCTION update_module_order()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW."order" IS NULL THEN
    SELECT COALESCE(MAX("order"), 0) + 10 INTO NEW."order"
    FROM module 
    WHERE project_id = NEW.project_id AND parent_id IS NOT DISTINCT FROM NEW.parent_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_module_order
  BEFORE INSERT ON module
  FOR EACH ROW
  EXECUTE FUNCTION update_module_order();
```

7.4 UseCase
```sql
CREATE TABLE use_case (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  module_id UUID NOT NULL REFERENCES module(id) ON DELETE CASCADE,
  uc_code TEXT NOT NULL,
  title TEXT NOT NULL,
  summary TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX ux_use_case_code ON use_case(project_id, uc_code);
CREATE INDEX ix_use_case_project ON use_case(project_id);
CREATE INDEX ix_use_case_module ON use_case(module_id);
```

7.5 SequenceDiagram
```sql
CREATE TABLE sequence_diagram (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  use_case_id UUID NOT NULL REFERENCES use_case(id) ON DELETE CASCADE,
  sd_code TEXT NOT NULL,
  title TEXT NOT NULL,
  mermaid_src TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX ux_sequence_code ON sequence_diagram(project_id, sd_code);
CREATE INDEX ix_sequence_project ON sequence_diagram(project_id);
CREATE INDEX ix_sequence_use_case ON sequence_diagram(use_case_id);
```

7.6 ApiContract
```sql
CREATE TABLE api_contract (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  api_code TEXT NOT NULL,
  method TEXT NOT NULL CHECK (method IN ('GET', 'POST', 'PUT', 'DELETE', 'PATCH')),
  path TEXT NOT NULL,
  title TEXT NOT NULL,
  desc TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX ux_api_code ON api_contract(project_id, api_code);
CREATE INDEX ix_api_project ON api_contract(project_id);
CREATE INDEX ix_api_method_path ON api_contract(project_id, method, path);
CREATE UNIQUE INDEX ux_api_method_path_unique ON api_contract(project_id, method, path);
```

7.7 DtoSchema
```sql
CREATE TABLE dto_schema (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  dto_code TEXT NOT NULL,
  title TEXT NOT NULL,
  schema_json JSONB NOT NULL,
  kind TEXT NOT NULL CHECK (kind IN ('request', 'response')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX ux_dto_code ON dto_schema(project_id, dto_code);
CREATE INDEX ix_dto_project ON dto_schema(project_id);
CREATE INDEX ix_dto_kind ON dto_schema(project_id, kind);
CREATE INDEX ix_dto_schema_gin ON dto_schema USING GIN (schema_json);
```

7.8 Links
```sql
CREATE TABLE api_sequence_link (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  api_id UUID NOT NULL REFERENCES api_contract(id) ON DELETE CASCADE,
  sequence_id UUID NOT NULL REFERENCES sequence_diagram(id) ON DELETE CASCADE,
  step_ref TEXT,
  line_number INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX ix_api_sequence_api ON api_sequence_link(api_id);
CREATE INDEX ix_api_sequence_sequence ON api_sequence_link(sequence_id);
CREATE UNIQUE INDEX ux_api_sequence_unique ON api_sequence_link(api_id, sequence_id, step_ref);

CREATE TABLE api_dto_link (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  api_id UUID NOT NULL REFERENCES api_contract(id) ON DELETE CASCADE,
  dto_id UUID NOT NULL REFERENCES dto_schema(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('req', 'res')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX ix_api_dto_link_api ON api_dto_link(api_id);
CREATE INDEX ix_api_dto_link_dto ON api_dto_link(dto_id);
CREATE UNIQUE INDEX ux_api_dto_role_unique ON api_dto_link(api_id, dto_id, role);
```

7.9 æ›´æ–°æ™‚é–“è§¸ç™¼å™¨
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ç‚ºæ‰€æœ‰éœ€è¦ updated_at çš„è¡¨æ·»åŠ è§¸ç™¼å™¨
CREATE TRIGGER trigger_update_project_updated_at
  BEFORE UPDATE ON project
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_module_updated_at
  BEFORE UPDATE ON module
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_use_case_updated_at
  BEFORE UPDATE ON use_case
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_sequence_diagram_updated_at
  BEFORE UPDATE ON sequence_diagram
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_api_contract_updated_at
  BEFORE UPDATE ON api_contract
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_dto_schema_updated_at
  BEFORE UPDATE ON dto_schema
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

8) è³‡æ–™å®‰å…¨èˆ‡æ¬Šé™æ§åˆ¶

8.1 è³‡æ–™éæ¿¾é‚è¼¯

8.1.1 å°ˆæ¡ˆæŸ¥è©¢éæ¿¾
- æ‰€æœ‰å°ˆæ¡ˆç›¸é—œæŸ¥è©¢éƒ½å¿…é ˆåŸºæ–¼ä½¿ç”¨è€…æ¬Šé™é€²è¡Œéæ¿¾
- ä½¿ç”¨è€…åªèƒ½çœ‹åˆ°æœ‰æ¬Šé™çš„å°ˆæ¡ˆï¼ˆOWNERã€EDITORã€VIEWERï¼‰
- æŸ¥è©¢æ™‚è‡ªå‹•åŠ å…¥ `project_id IN (SELECT project_id FROM project_member WHERE user_id = ?)` æ¢ä»¶

8.1.2 æ¬Šé™æª¢æŸ¥å¯¦ä½œ
```typescript
// project.service.ts ä¸­çš„ findAll æ–¹æ³•
async findAll(params: ProjectListParams = {}, userId: string): Promise<{
  data: Project[];
  total: number;
  page: number;
  totalPages: number;
}> {
  const {
    page = 1,
    limit = 10,
    search,
    status,
    sortBy = 'createdAt',
    sortOrder = 'desc',
  } = params;

  const skip = (page - 1) * limit;
  
  const where: Prisma.ProjectWhereInput = {
    // æ¬Šé™éæ¿¾ï¼šåªé¡¯ç¤ºæœ‰æ¬Šé™çš„å°ˆæ¡ˆ
    OR: [
      { ownerId: userId }, // æ“æœ‰è€…
      { 
        members: { 
          some: { 
            userId: userId,
            role: { in: ['OWNER', 'EDITOR', 'VIEWER'] }
          } 
        } 
      }
    ]
  };
  
  if (search) {
    where.AND = [{
      OR: [
        { name: { contains: search, mode: 'insensitive' } },
        { description: { contains: search, mode: 'insensitive' } },
        { projectCode: { contains: search, mode: 'insensitive' } },
      ]
    }];
  }
  
  if (status) {
    where.status = status;
  }

  const [data, total] = await Promise.all([
    this.prisma.project.findMany({
      where,
      skip,
      take: limit,
      orderBy: { [sortBy]: sortOrder },
      include: {
        members: {
          where: { userId },
          select: { role: true }
        }
      }
    }),
    this.prisma.project.count({ where }),
  ]);

  return {
    data,
    total,
    page,
    totalPages: Math.ceil(total / limit),
  };
}
```

8.2 ä½µç™¼è™•ç†èˆ‡æ•ˆèƒ½å„ªåŒ–

8.2.1 æµæ°´è™Ÿåˆ†é…å„ªåŒ–

- ä½¿ç”¨ Redis åˆ†æ•£å¼é–ï¼Œé¿å…è³‡æ–™åº«é–ç«¶çˆ­
- æ‰¹é‡å»ºç«‹æ™‚é åˆ†é…è™Ÿç¢¼ç¯„åœï¼Œæ¸›å°‘é–å®šæ¬¡æ•¸
- å¤±æ•—é‡è©¦ä½¿ç”¨æŒ‡æ•¸é€€é¿ç­–ç•¥

8.2 Mermaid è§£æå„ªåŒ–

- ä½¿ç”¨ Worker Pool è™•ç†å¤§é‡è§£æä»»å‹™
- è§£æçµæœå¿«å–ï¼Œé¿å…é‡è¤‡è§£æ
- å¢é‡è§£æï¼šåªè§£æè®Šæ›´çš„éƒ¨åˆ†

8.3 æŸ¥è©¢æ•ˆèƒ½å„ªåŒ–

- è¤‡åˆç´¢å¼•æ”¯æ´å¤šæ¢ä»¶æŸ¥è©¢
- åˆ†é æŸ¥è©¢ä½¿ç”¨æ¸¸æ¨™åˆ†é ï¼ˆCursor-based Paginationï¼‰
- å¤§é‡è³‡æ–™ä½¿ç”¨éåŒæ­¥è™•ç†

9) éŒ¯èª¤è™•ç†ã€æ—¥èªŒèˆ‡å®‰å…¨ç›£æ§

9.1 éŒ¯èª¤ä»£ç¢¼å®šç¾©

**èªè­‰èˆ‡æ¬Šé™ç›¸é—œéŒ¯èª¤**ï¼š
- AUTH_TOKEN_MISSINGï¼šç¼ºå°‘èªè­‰ Token
- AUTH_TOKEN_INVALIDï¼šToken ç„¡æ•ˆ
- AUTH_TOKEN_EXPIREDï¼šToken å·²éæœŸ
- AUTH_TOKEN_REVOKEDï¼šToken å·²è¢«æ’¤éŠ·
- PERMISSION_DENIEDï¼šç„¡æ¬Šé™å­˜å–æ­¤å°ˆæ¡ˆ
- INSUFFICIENT_PERMISSIONï¼šæ¬Šé™ä¸è¶³
- PROJECT_ACCESS_DENIEDï¼šå°ˆæ¡ˆå­˜å–è¢«æ‹’çµ•
- MEMBER_NOT_FOUNDï¼šå°ˆæ¡ˆæˆå“¡ä¸å­˜åœ¨
- INVITATION_EXPIREDï¼šé‚€è«‹å·²éæœŸ
- INVITATION_ALREADY_ACCEPTEDï¼šé‚€è«‹å·²è¢«æ¥å—

**èªè­‰ç›¸é—œéŒ¯èª¤**ï¼š

**èªè­‰ç›¸é—œéŒ¯èª¤**ï¼š
- AUTH_INVALID_CREDENTIALSï¼šç„¡æ•ˆçš„ç™»å…¥æ†‘è­‰
- AUTH_ACCOUNT_LOCKEDï¼šå¸³è™Ÿå·²è¢«é–å®š
- AUTH_ACCOUNT_INACTIVEï¼šå¸³è™Ÿæœªå•Ÿç”¨
- AUTH_TOKEN_EXPIREDï¼šToken å·²éæœŸ
- AUTH_TOKEN_INVALIDï¼šToken ç„¡æ•ˆ
- AUTH_TOKEN_REVOKEDï¼šToken å·²è¢«æ’¤éŠ·
- AUTH_INSUFFICIENT_PERMISSIONï¼šæ¬Šé™ä¸è¶³
- AUTH_TOO_MANY_ATTEMPTSï¼šç™»å…¥å˜—è©¦æ¬¡æ•¸éå¤š
- AUTH_PASSWORD_TOO_WEAKï¼šå¯†ç¢¼å¼·åº¦ä¸è¶³
- AUTH_EMAIL_NOT_VERIFIEDï¼šEmail æœªé©—è­‰

**æ¥­å‹™é‚è¼¯éŒ¯èª¤**ï¼š
- VALIDATION_ERRORï¼šè³‡æ–™é©—è­‰å¤±æ•—
- NOT_FOUNDï¼šè³‡æºä¸å­˜åœ¨
- DUPLICATE_CODEï¼šä»£ç¢¼é‡è¤‡
- CONSISTENCY_ERRORï¼šä¸€è‡´æ€§æª¢æŸ¥å¤±æ•—
- SYSTEM_ERRORï¼šç³»çµ±å…§éƒ¨éŒ¯èª¤

9.2 æ—¥èªŒè¨˜éŒ„èˆ‡å®‰å…¨ç›£æ§

9.2.1 ç¨½æ ¸æ—¥èªŒ
- æ‰€æœ‰ CRUD æ“ä½œè¨˜éŒ„åˆ°ç¨½æ ¸æ—¥èªŒ
- å°ˆæ¡ˆå­˜å–è¨˜éŒ„ï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
- æ¬Šé™è®Šæ›´è¨˜éŒ„
- æˆå“¡é‚€è«‹/ç§»é™¤è¨˜éŒ„
- ä»£ç¢¼ç”Ÿæˆå¤±æ•—è¨˜éŒ„åˆ°éŒ¯èª¤æ—¥èªŒ
- ä¸€è‡´æ€§æª¢æŸ¥çµæœè¨˜éŒ„åˆ°ç³»çµ±æ—¥èªŒ
- æ”¯æ´çµæ§‹åŒ–æ—¥èªŒï¼Œä¾¿æ–¼åˆ†æ

9.2.2 å®‰å…¨ç›£æ§
- ç™»å…¥å¤±æ•—æ¬¡æ•¸ç›£æ§
- ç•°å¸¸å­˜å–æ¨¡å¼æª¢æ¸¬
- Token æ¿«ç”¨æª¢æ¸¬
- æ¬Šé™æå‡å˜—è©¦ç›£æ§
- å¤§é‡è³‡æ–™æŸ¥è©¢ç›£æ§
- å¯ç–‘ IP ä½å€è¿½è¹¤

10) éƒ¨ç½²èˆ‡ç›£æ§

10.1 å¥åº·æª¢æŸ¥

- GET /healthï¼šåŸºæœ¬å¥åº·ç‹€æ…‹
- GET /health/dbï¼šè³‡æ–™åº«é€£ç·šç‹€æ…‹
- GET /health/consistencyï¼šä¸€è‡´æ€§æª¢æŸ¥ç‹€æ…‹

10.2 æ•ˆèƒ½ç›£æ§

- API éŸ¿æ‡‰æ™‚é–“ç›£æ§
- è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½ç›£æ§
- è¨˜æ†¶é«”èˆ‡ CPU ä½¿ç”¨ç‡ç›£æ§

10.3 å‚™ä»½ç­–ç•¥

- å®šæœŸå‚™ä»½è³‡æ–™åº«
- ä»£ç¢¼ç”Ÿæˆè¨˜éŒ„å‚™ä»½
- ç½é›£æ¢å¾©æ–¹æ¡ˆ

é€™ä»½å„ªåŒ–ç‰ˆè¦æ ¼è§£æ±ºäº†åŸå§‹ç‰ˆæœ¬çš„æ‰€æœ‰ä¸»è¦å•é¡Œï¼Œæä¾›äº†æ›´ç©©å®šã€é«˜æ•ˆã€å¯ç¶­è­·çš„ç³»çµ±è¨­è¨ˆã€‚

## ğŸ” å®‰å…¨å¯¦ä½œæª¢æŸ¥æ¸…å–®

### å¯¦ä½œé †åº
1. **å»ºç«‹èªè­‰ä¸­ä»‹è»Ÿé«”** (`auth.middleware.ts`)
   - JWT Token é©—è­‰
   - ä½¿ç”¨è€…è³‡è¨Šè§£æ
   - éŒ¯èª¤è™•ç†

2. **å»ºç«‹æ¬Šé™æª¢æŸ¥ä¸­ä»‹è»Ÿé«”** (`permission.middleware.ts`)
   - å°ˆæ¡ˆæ¬Šé™é©—è­‰
   - è§’è‰²æ¬Šé™æª¢æŸ¥
   - æ¬Šé™ä¸è¶³è™•ç†

3. **ä¿®æ”¹è³‡æ–™åº«çµæ§‹**
   - æ–°å¢ `project_member` è¡¨
   - ä¿®æ”¹ `project` è¡¨ï¼ŒåŠ å…¥ `owner_id` å’Œ `status` æ¬„ä½
   - å»ºç«‹å¿…è¦çš„ç´¢å¼•

4. **ä¿®æ”¹å°ˆæ¡ˆæœå‹™**
   - åŠ å…¥æ¬Šé™éæ¿¾é‚è¼¯
   - å¯¦ä½œæˆå“¡ç®¡ç†åŠŸèƒ½
   - åŠ å…¥æ¬Šé™æª¢æŸ¥

5. **ä¿®æ”¹æ‰€æœ‰æ¥­å‹™è·¯ç”±**
   - åŠ å…¥èªè­‰ä¸­ä»‹è»Ÿé«”
   - åŠ å…¥æ¬Šé™æª¢æŸ¥ä¸­ä»‹è»Ÿé«”
   - ç§»é™¤ `@access Public` æ¨™è¨˜

6. **åŠ å…¥ç¨½æ ¸æ—¥èªŒ**
   - è¨˜éŒ„æ‰€æœ‰å­˜å–æ“ä½œ
   - è¨˜éŒ„æ¬Šé™è®Šæ›´
   - è¨˜éŒ„å®‰å…¨äº‹ä»¶

### å®‰å…¨æ³¨æ„äº‹é …
- **Token å®‰å…¨**ï¼šä½¿ç”¨å¼·å¯†ç¢¼ä½œç‚º JWT Secretï¼Œå®šæœŸè¼ªæ›
- **æ¬Šé™æœ€å°åŒ–**ï¼šä½¿ç”¨è€…åªèƒ½å­˜å–å¿…è¦çš„è³‡æº
- **è¼¸å…¥é©—è­‰**ï¼šæ‰€æœ‰è¼¸å…¥éƒ½å¿…é ˆç¶“éé©—è­‰å’Œæ¸…ç†
- **SQL æ³¨å…¥é˜²è­·**ï¼šä½¿ç”¨ Prisma ORM é¿å… SQL æ³¨å…¥
- **XSS é˜²è­·**ï¼šè¼¸å‡ºæ™‚é€²è¡Œé©ç•¶çš„ç·¨ç¢¼
- **CSRF é˜²è­·**ï¼šä½¿ç”¨é©ç•¶çš„ CSRF Token
- **é€Ÿç‡é™åˆ¶**ï¼šå¯¦ä½œ API é€Ÿç‡é™åˆ¶é˜²æ­¢æ¿«ç”¨
- **æ—¥èªŒå®‰å…¨**ï¼šé¿å…è¨˜éŒ„æ•æ„Ÿè³‡è¨Šï¼Œä¿è­·æ—¥èªŒæª”æ¡ˆ

### æ¸¬è©¦è¦æ±‚
- **èªè­‰æ¸¬è©¦**ï¼šæ¸¬è©¦å„ç¨®èªè­‰å ´æ™¯
- **æ¬Šé™æ¸¬è©¦**ï¼šæ¸¬è©¦ä¸åŒè§’è‰²çš„æ¬Šé™
- **å®‰å…¨æ¸¬è©¦**ï¼šæ¸¬è©¦å¸¸è¦‹çš„å®‰å…¨æ¼æ´
- **æ•ˆèƒ½æ¸¬è©¦**ï¼šç¢ºä¿æ¬Šé™æª¢æŸ¥ä¸å½±éŸ¿æ•ˆèƒ½
- **æ•´åˆæ¸¬è©¦**ï¼šæ¸¬è©¦å®Œæ•´çš„èªè­‰å’Œæ¬Šé™æµç¨‹