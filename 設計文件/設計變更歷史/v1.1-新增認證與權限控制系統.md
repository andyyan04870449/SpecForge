# 設計變更歷史 - v1.1 新增認證與權限控制系統

**變更日期**：2024-12-19  
**變更版本**：v1.1  
**變更類型**：重大功能新增  
**影響範圍**：全系統安全性架構  

## 📋 變更概述

本次變更主要解決系統安全性問題，新增完整的認證與權限控制系統，確保所有業務 API 都有適當的存取控制。

## 🔍 問題背景

### 原始問題
1. **API 沒有認證保護**：所有專案 API 都標記為 `@access Public`
2. **資料查詢沒有過濾**：查詢專案時沒有基於 `ownerId` 過濾
3. **缺少認證中介軟體**：專案相關路由沒有使用 JWT 驗證

### 安全風險
- 任何人都可以存取所有專案
- 使用者可以看到其他人的專案
- 沒有權限控制，可能導致資料洩露

## 🚀 新增功能

### 1. 認證中介軟體（Authentication Middleware）
- **檔案**：`backend/src/middlewares/auth.middleware.ts`
- **功能**：JWT Token 驗證、使用者資訊解析
- **實作要點**：
  ```typescript
  export const authenticateToken = async (req: Request, res: Response, next: NextFunction)
  ```

### 2. 權限控制中介軟體（Authorization Middleware）
- **檔案**：`backend/src/middlewares/permission.middleware.ts`
- **功能**：專案權限檢查、角色權限驗證
- **實作要點**：
  ```typescript
  export const checkProjectPermission = (requiredRole: 'OWNER' | 'EDITOR' | 'VIEWER')
  ```

### 3. 專案成員權限模型
- **新增資料表**：`project_member`
- **角色定義**：
  - `OWNER`：完全控制權限
  - `EDITOR`：可編輯內容，不可刪除專案
  - `VIEWER`：只能查看，不可修改

## 📊 資料模型變更

### 新增資料表
```sql
-- 專案成員權限表
CREATE TABLE project_member (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES project(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('OWNER', 'EDITOR', 'VIEWER')),
  permissions JSONB DEFAULT '{}',
  invited_by UUID REFERENCES "user"(id) ON DELETE SET NULL,
  invited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  accepted_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 修改現有資料表
```sql
-- 專案表新增欄位
ALTER TABLE project ADD COLUMN owner_id UUID REFERENCES "user"(id) ON DELETE SET NULL;
ALTER TABLE project ADD COLUMN status TEXT NOT NULL DEFAULT 'PLANNING' CHECK (status IN ('PLANNING', 'IN_PROGRESS', 'REVIEW', 'COMPLETED'));
```

## 🔐 API 權限變更

### 認證要求
- **所有業務 API**：都需要認證（移除 `@access Public` 標記）
- **認證方式**：`Authorization: Bearer <token>` Header

### 權限要求
| API 端點 | 讀取權限 | 寫入權限 | 刪除權限 |
|----------|----------|----------|----------|
| `/projects` | VIEWER+ | EDITOR+ | OWNER |
| `/modules` | VIEWER+ | EDITOR+ | EDITOR+ |
| `/use-cases` | VIEWER+ | EDITOR+ | EDITOR+ |
| `/sequences` | VIEWER+ | EDITOR+ | EDITOR+ |
| `/apis` | VIEWER+ | EDITOR+ | EDITOR+ |
| `/dtos` | VIEWER+ | EDITOR+ | EDITOR+ |

### 新增 API 端點
```
POST /projects/:id/members → 邀請成員（OWNER）
GET /projects/:id/members → 取得成員列表（VIEWER+）
PATCH /projects/:id/members/:memberId → 修改成員權限（OWNER）
DELETE /projects/:id/members/:memberId → 移除成員（OWNER）
```

## 💻 程式碼實作要求

### 1. 建立中介軟體檔案
- `backend/src/middlewares/auth.middleware.ts`
- `backend/src/middlewares/permission.middleware.ts`

### 2. 修改專案服務
- **檔案**：`backend/src/services/project.service.ts`
- **變更**：加入權限過濾邏輯、實作成員管理功能

### 3. 修改所有業務路由
- **檔案**：所有 `*.routes.ts` 檔案
- **變更**：
  - 加入 `authenticateToken` 中介軟體
  - 加入適當的權限檢查中介軟體
  - 移除 `@access Public` 標記

### 4. 資料庫遷移
- 建立 `project_member` 表
- 修改 `project` 表結構
- 建立必要的索引

## 🔄 實作順序

1. **建立認證中介軟體** (`auth.middleware.ts`)
2. **建立權限檢查中介軟體** (`permission.middleware.ts`)
3. **修改資料庫結構**
4. **修改專案服務**
5. **修改所有業務路由**
6. **加入稽核日誌**

## ⚠️ 重要注意事項

### 安全性要求
- 使用強密碼作為 JWT Secret
- 實作 Token 過期處理
- 加入速率限制防止濫用
- 記錄所有存取操作到稽核日誌

### 相容性考慮
- 現有專案需要設定 `owner_id`
- 現有使用者需要加入專案成員表
- 考慮資料遷移腳本

### 測試要求
- 認證流程測試
- 權限控制測試
- 安全漏洞測試
- 效能影響測試

## 📝 變更檢查清單

- [ ] 建立認證中介軟體
- [ ] 建立權限檢查中介軟體
- [ ] 新增 `project_member` 資料表
- [ ] 修改 `project` 資料表
- [ ] 更新專案服務邏輯
- [ ] 修改所有業務路由
- [ ] 移除 `@access Public` 標記
- [ ] 加入稽核日誌
- [ ] 更新 Swagger 文件
- [ ] 進行安全性測試

## 🔗 相關文件

- [設計初稿規格.md](../設計初稿規格.md) - 主要規格文件
- [技術棧與架構規格.md](../技術棧與架構規格.md) - 技術架構文件
- [API端點清單.md](../API端點清單.md) - API 端點清單

---

**變更記錄者**：AI 助手  
**審核狀態**：待審核  
**下次審核日期**：2024-12-26
