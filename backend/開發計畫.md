# SpecForge 後端開發計畫

## 📅 最後更新：2025-09-02 15:00

## 🎯 專案目標
開發一個系統分析設計平台的後端 API，支援專案管理、模組設計、用例管理、序列圖設計、API 合約管理等功能。

## 📊 當前進度總覽

### ✅ 已完成項目（約 45%）

#### 1. 基礎架構設置
- [x] Express + TypeScript 專案結構
- [x] Prisma ORM 配置與資料庫模型
- [x] 環境變數管理（config/env.ts）
- [x] PostgreSQL 資料庫連線
- [x] Redis 連線與快取助手
- [x] 錯誤處理中間件
- [x] 基礎中間件（CORS, Helmet, Morgan, Rate Limiting）

#### 2. 資料庫設計
- [x] 完整的 Prisma Schema（11 個實體）
  - Project, Module, UseCase, Sequence
  - ApiContract, DtoSchema, ApiSequenceLink, ApiDtoLink
  - CodeGeneratorOptions, SeqCounter, ConsistencyReport
- [x] 關聯關係設定（CASCADE 刪除策略）
- [x] 索引優化

#### 3. 核心服務
- [x] 流水號生成服務（codeGenerator.service.ts）
  - 支援併發安全（SERIALIZABLE 隔離級別）
  - 自動重試機制（最多 3 次）
  - 範圍型計數器（模組、用例、序列等）

#### 4. 健康檢查 API
- [x] GET /health - 基本健康檢查
- [x] GET /health/ready - 就緒狀態檢查
- [x] GET /health/live - 存活狀態檢查
- [x] GET /health/db - 資料庫連線狀態
- [x] GET /health/consistency - 一致性檢查服務狀態
- [x] GET /health/detailed - 詳細系統狀態

### 🚧 待開發項目（約 45%）

## 📋 詳細開發任務清單

### Phase 1: CRUD API 實作（優先級：高）

#### 1.1 Project 管理 API ✅ **已完成**
- [x] GET /api/v1/projects - 查詢專案列表
- [x] GET /api/v1/projects/{projectId} - 取得專案詳情
- [x] GET /api/v1/projects/{projectId}/statistics - 取得專案統計
- [x] POST /api/v1/projects - 建立專案
- [x] PUT /api/v1/projects/{projectId} - 更新專案
- [x] DELETE /api/v1/projects/{projectId} - 刪除專案
- [x] 實作 Service 層邏輯
- [x] 加入資料驗證（Joi）
- [ ] 單元測試（待實作）

**實際用時：1.5 小時** | **預估時間：3 小時**

#### 1.2 Module 管理 API ✅ **已完成**
- [x] GET /api/v1/projects/{projectId}/modules - 查詢模組列表
- [x] GET /api/v1/projects/{projectId}/modules/tree - 取得樹狀結構
- [x] GET /api/v1/modules/{moduleId} - 取得模組詳情
- [x] POST /api/v1/projects/{projectId}/modules - 建立模組
- [x] PUT /api/v1/modules/{moduleId} - 更新模組
- [x] PUT /api/v1/modules/{moduleId}/reorder - 調整順序
- [x] DELETE /api/v1/modules/{moduleId} - 刪除模組
- [x] 處理樹狀結構邏輯（父子關係）
- [x] 循環依賴檢查
- [x] 實作 Service 層邏輯
- [ ] 單元測試（待實作）

**實際用時：45 分鐘** | **預估時間：4 小時**

#### 1.3 UseCase 管理 API ✅ **已完成**
- [x] GET /api/v1/modules/{moduleId}/use-cases - 查詢用例列表
- [x] GET /api/v1/modules/{moduleId}/use-cases/stats - 取得統計資料
- [x] GET /api/v1/use-cases/{useCaseId} - 取得用例詳情
- [x] POST /api/v1/modules/{moduleId}/use-cases - 建立用例
- [x] POST /api/v1/modules/{moduleId}/use-cases/batch - 批量建立
- [x] POST /api/v1/use-cases/{useCaseId}/duplicate - 複製用例
- [x] PUT /api/v1/use-cases/{useCaseId} - 更新用例
- [x] PUT /api/v1/use-cases/{useCaseId}/move - 移動到其他模組
- [x] DELETE /api/v1/use-cases/{useCaseId} - 刪除用例
- [x] 實作 Service 層邏輯
- [ ] 單元測試（待實作）

**實際用時：30 分鐘** | **預估時間：3 小時**

#### 1.4 Sequence Diagram 管理 API ✅ **已完成**
- [x] GET /api/v1/use-cases/{useCaseId}/sequences - 查詢序列圖列表
- [x] GET /api/v1/sequences/{sequenceId} - 取得序列圖詳情
- [x] GET /api/v1/sequences/example - 取得範例
- [x] POST /api/v1/use-cases/{useCaseId}/sequences - 建立序列圖
- [x] POST /api/v1/sequences/{sequenceId}/reparse - 重新解析
- [x] POST /api/v1/sequences/{sequenceId}/duplicate - 複製序列圖
- [x] PUT /api/v1/sequences/{sequenceId} - 更新序列圖
- [x] DELETE /api/v1/sequences/{sequenceId} - 刪除序列圖
- [x] GET /api/v1/projects/{projectId}/sequences/parse-errors - 取得解析錯誤列表
- [x] Mermaid 語法驗證與解析（儲存但標記錯誤）
- [x] 實作 Service 層邏輯
- [ ] 單元測試（待實作）

**實際用時：30 分鐘** | **預估時間：4 小時**

#### 1.5 API Contract 管理 API ✅ **已完成**
- [x] GET /api/v1/projects/{projectId}/apis - 查詢 API 列表
- [x] GET /api/v1/projects/{projectId}/apis/stats - 取得 API 統計
- [x] GET /api/v1/projects/{projectId}/apis/openapi - 產生 OpenAPI 規格
- [x] GET /api/v1/apis/{apiId} - 取得 API 詳情
- [x] POST /api/v1/projects/{projectId}/apis - 建立 API
- [x] PUT /api/v1/apis/{apiId} - 更新 API
- [x] DELETE /api/v1/apis/{apiId} - 刪除 API
- [x] 實作 Service 層邏輯
- [x] 加入資料驗證（Joi）
- [x] OpenAPI 規格產生功能
- [ ] 單元測試（待實作）

**實際用時：30 分鐘** | **預估時間：3 小時**

#### 1.6 DTO Schema 管理 API ✅ **已完成**
- [x] GET /api/v1/projects/{projectId}/dtos - 查詢 DTO 列表
- [x] GET /api/v1/projects/{projectId}/dtos/stats - 取得 DTO 統計
- [x] GET /api/v1/dtos/{dtoId} - 取得 DTO 詳情
- [x] GET /api/v1/dtos/{dtoId}/typescript - 產生 TypeScript 介面
- [x] POST /api/v1/projects/{projectId}/dtos - 建立 DTO
- [x] POST /api/v1/projects/{projectId}/dtos/batch - 批次建立 DTO
- [x] PUT /api/v1/dtos/{dtoId} - 更新 DTO
- [x] DELETE /api/v1/dtos/{dtoId} - 刪除 DTO
- [x] JSON Schema 驗證
- [x] 實作 Service 層邏輯
- [x] TypeScript 介面產生功能
- [ ] 單元測試（待實作）

**實際用時：25 分鐘** | **預估時間：3 小時**

#### 1.7 關聯管理 API ✅ **已完成**
- [x] API-Sequence 關聯管理
  - [x] GET /api/v1/api-sequence-links - 查詢關聯列表
  - [x] GET /api/v1/api-sequence-links/{linkId} - 取得關聯詳情
  - [x] GET /api/v1/api-sequence-links/api/{apiId}/sequences - 取得 API 相關序列圖
  - [x] GET /api/v1/api-sequence-links/sequence/{sequenceId}/apis - 取得序列圖相關 APIs
  - [x] POST /api/v1/api-sequence-links - 建立關聯
  - [x] POST /api/v1/api-sequence-links/batch - 批次建立關聯
  - [x] POST /api/v1/api-sequence-links/sequence/{sequenceId}/auto-detect - 自動偵測關聯
  - [x] PUT /api/v1/api-sequence-links/{linkId} - 更新關聯
  - [x] DELETE /api/v1/api-sequence-links/{linkId} - 刪除關聯
- [x] API-DTO 關聯管理
  - [x] GET /api/v1/api-dto-links - 查詢關聯列表
  - [x] GET /api/v1/api-dto-links/{linkId} - 取得關聯詳情
  - [x] GET /api/v1/api-dto-links/stats - 取得統計資訊
  - [x] GET /api/v1/api-dto-links/api/{apiId}/dtos - 取得 API 相關 DTOs
  - [x] GET /api/v1/api-dto-links/dto/{dtoId}/apis - 取得 DTO 相關 APIs
  - [x] POST /api/v1/api-dto-links - 建立關聯
  - [x] POST /api/v1/api-dto-links/batch - 批次建立關聯
  - [x] POST /api/v1/api-dto-links/api/{apiId}/auto-generate - 自動產生 DTOs
  - [x] PUT /api/v1/api-dto-links/{linkId} - 更新關聯
  - [x] DELETE /api/v1/api-dto-links/{linkId} - 刪除關聯
- [x] 實作 Service 層邏輯
- [x] 自動偵測與產生功能
- [ ] 單元測試（待實作）

**實際用時：40 分鐘** | **預估時間：2 小時**

### Phase 2: 進階功能實作（優先級：中）

#### 2.1 Mermaid 解析服務 ✅ **已完成**
- [x] 建立 mermaidParser.service.ts
- [x] 實作序列圖解析邏輯
- [x] 提取參與者、訊息、API 呼叫資訊
- [x] 錯誤處理與回報（儲存但標記錯誤）
- [ ] 單元測試（待實作）

**實際用時：已包含在 Sequence Diagram API 中** | **預估時間：4 小時**

#### 2.2 一致性檢查服務 ✅ **已完成**
- [x] 建立 consistencyChecker.service.ts
- [x] 實作序列圖與 API 合約一致性檢查
- [x] 實作 DTO 使用一致性檢查
- [x] 產生檢查報告
- [x] POST /api/v1/consistency/check - 執行一致性檢查
- [x] GET /api/v1/consistency/report/{projectId} - 取得檢查報告
- [ ] 單元測試

**實際用時：20 分鐘** | **預估時間：5 小時**

#### 2.3 目錄服務 ✅ **已完成**
- [x] GET /api/v1/catalog - 完整目錄
- [x] GET /api/v1/catalog/modules - 模組目錄
- [x] GET /api/v1/catalog/apis - API 目錄
- [x] GET /api/v1/catalog/dtos - DTO 目錄
- [x] 實作過濾與排序功能
- [ ] 單元測試

**實際用時：15 分鐘** | **預估時間：2 小時**

#### 2.4 匯入匯出功能 ✅ **已完成**
- [x] POST /api/v1/export/project/{projectId} - 匯出專案資料（JSON）
- [x] GET /api/v1/export/project/{projectId}/openapi - 匯出 OpenAPI 規格
- [x] GET /api/v1/export/project/{projectId}/markdown - 匯出 Markdown 文件
- [x] POST /api/v1/import/project - 匯入專案資料
- [x] POST /api/v1/import/validate - 驗證匯入資料
- [x] 資料驗證與衝突處理
- [ ] 單元測試

**實際用時：25 分鐘** | **預估時間：3 小時**

### Phase 3: AI 功能（優先級：低）

#### 3.1 AI 生成服務（Mock 版本）✅ **已完成**
- [x] 建立 aiGenerator.service.ts
- [x] 實作 Mock 生成邏輯
- [x] POST /api/v1/ai/generate - 統一生成入口（type: sequence/api/dto）
- [x] GET /api/v1/ai/drafts/{draftId} - 取得草稿
- [x] POST /api/v1/ai/adopt-draft - 採用草稿
- [x] DELETE /api/v1/ai/drafts/{draftId} - 刪除草稿
- [x] POST /api/v1/ai/suggest-apis - 根據序列圖建議 API
- [x] POST /api/v1/ai/suggest-dtos - 根據 API 建議 DTO
- [x] 預留真實 AI 整合介面
- [ ] 單元測試

**實際用時：1 小時** | **預估時間：4 小時**

### Phase 4: 測試與優化（優先級：中）

#### 4.1 單元測試
- [ ] Services 層測試覆蓋率 > 80%
- [ ] Routes 層測試
- [ ] 中間件測試
- [ ] 錯誤處理測試

**預估時間：6 小時**

#### 4.2 整合測試
- [ ] API 端對端測試
- [ ] 資料庫事務測試
- [ ] 併發測試
- [ ] 效能測試

**預估時間：4 小時**

#### 4.3 效能優化
- [ ] 資料庫查詢優化
- [ ] 快取策略實作
- [ ] 分頁優化
- [ ] N+1 查詢問題處理

**預估時間：3 小時**

#### 4.4 文檔與部署
- [ ] API 文檔（OpenAPI/Swagger）
- [ ] 部署腳本
- [ ] Docker 配置
- [ ] 生產環境配置

**預估時間：3 小時**

## 📈 時間估算統計

| 階段 | 預估時間 | 實際用時 | 優先級 | 狀態 |
|------|---------|---------|--------|------|
| Phase 1: CRUD API | 22 小時 | 3.5 小時 | 高 | ✅ 已完成 |
| Phase 2: 進階功能 | 14 小時 | 1 小時 | 中 | ✅ 已完成 |
| Phase 3: AI 功能 | 4 小時 | 1 小時 | 低 | ✅ 已完成 |
| Phase 4: 測試與優化 | 16 小時 | - | 中 | ⏳ 待開發 |
| **總計** | **56 小時** | **5.5 小時** | - | **60% 完成** |

## 🚀 執行策略

### 短期目標（1-2 週）
1. 完成所有 CRUD API（Phase 1）
2. 實作 Mermaid 解析服務
3. 基本單元測試

### 中期目標（3-4 週）
1. 完成一致性檢查功能
2. 實作匯入匯出功能
3. 完善測試覆蓋率

### 長期目標（1-2 個月）
1. AI 功能整合
2. 效能優化
3. 生產部署準備

## 🔧 技術債清單

1. **需要重構的項目**
   - [ ] 將 logger 從 errorHandler.ts 抽離為獨立模組
   - [ ] 統一驗證邏輯（建立 validation 中間件）
   - [ ] 抽離業務邏輯至 Service 層

2. **需要補充的配置**
   - [ ] 日誌持久化配置
   - [ ] 資料庫連線池優化
   - [ ] Redis 快取策略配置

3. **安全性增強**
   - [ ] API 認證授權（JWT）
   - [ ] 輸入驗證強化
   - [ ] SQL 注入防護驗證

## 📝 開發規範

### 程式碼規範
- TypeScript 嚴格模式
- ESLint + Prettier 格式化
- 函式單一職責原則
- 完整的型別定義

### Git 規範
- Feature Branch 開發
- Commit 訊息格式：`type(scope): description`
- Pull Request 需通過測試

### 測試規範
- 單元測試覆蓋率 > 80%
- 整合測試覆蓋主要流程
- 每個 PR 需包含相應測試

## 🐛 已知問題

1. Redis 連線為可選，需處理無 Redis 情況
2. 流水號生成在高併發下可能需要優化
3. Mermaid 解析錯誤處理需要更詳細的錯誤訊息

## 📅 更新記錄

### 2025-09-02 16:30
- ✅ 完成 Phase 2 所有進階功能
  - 一致性檢查服務（8 項檢查規則）
  - 目錄服務（完整的資源目錄功能）
  - 匯入匯出功能（JSON、OpenAPI、Markdown）
  - 搜尋服務（全文搜尋功能）
- ✅ 完成 Phase 3 AI 生成功能（Mock 版本）
  - 序列圖生成
  - API 規格生成
  - DTO Schema 生成
  - 草稿管理功能
  - AI 建議功能
- 修復 TypeScript 編譯錯誤
- **已完成 60% 的開發工作，僅餘測試與優化階段**

### 2025-09-02 15:00
- ✅ 完成 API Contract 管理 API 全部功能
- ✅ 完成 DTO Schema 管理 API 全部功能
- ✅ 完成 Link Management APIs（API-Sequence、API-DTO）
- 實作 OpenAPI 規格產生功能
- 實作 TypeScript 介面產生功能
- 實作關聯自動偵測與產生功能
- 修復 Prisma schema 欄位不一致問題
- **Phase 1 所有 CRUD API 已全部完成**

### 2025-09-02 14:30
- ✅ 完成 Sequence Diagram 管理 API 全部功能
- 實作 Mermaid 語法解析與驗證
- 實作序列圖複製、重新解析等功能
- 修復流水號生成範圍問題
- 成功測試所有 Sequence API 端點

### 2025-09-02 14:00
- ✅ 完成 UseCase 管理 API 全部功能
- 實作批量建立、複製、移動等進階功能
- 實作用例統計功能
- 成功測試所有 UseCase API 端點

### 2025-09-02 13:30
- ✅ 完成 Module 管理 API 全部功能
- 實作樹狀結構處理與循環依賴檢查
- 實作模組順序調整功能
- 成功測試模組建立、查詢、樹狀結構等功能

### 2025-09-02 13:00
- ✅ 完成 Project 管理 API 全部功能
- 實作 Project Service、Controller、Routes
- 加入 Joi 資料驗證
- 修復資料庫連線問題
- 成功測試所有 Project API 端點

### 2025-09-02 10:00
- 初始版本建立
- 分析現有程式碼與設計文件差距
- 制定詳細開發計畫

---

**注意事項：**
- 此計畫為動態文件，會隨開發進度持續更新
- 預估時間可能因實際開發狀況調整
- 優先處理高優先級項目以確保核心功能完成